---
title: 'Creating BHI reporting boundaries'
author: "Julie"
date: "6/27/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) # install.packages("tidyverse")
library(stringr) # install.packages("stringr")
library(sf) # install.packages("sf")
library(mapview) # install.packages("mapview")
library(here) # install.packages("here")
library(smoothr) # install.packages("smoothr")

## shapefile information
dir_spatial <- file.path(here::here(), "baltic2015/spatial")
bhi_filename <- "regions_gcs"

## regions_lookup
regions_lookup <- read_csv(file.path(dir_spatial, "regions_lookup_complete_wide.csv")) 
```
Also investigated these but they all have terrible lines that would be nice to drop

- bhi_filename <- "BHI_EEZ_regions"  
- bhi_filename <- "BHI_SUBBASIN_regions"

## read in shapefile
```{r}
rgns_bhi <- sf::st_read(dsn = dir_spatial, layer=bhi_filename)
rgns_bhi %>% mapview
# plot(rgns_bhi)

names(rgns_bhi)
nrow(rgns_bhi) # 42
rgns_bhi
```

## Wrangle and join dataframe

Note: how to [split string column into multiple columns](https://stackoverflow.com/questions/4350440/split-data-frame-string-column-into-multiple-columns)

Not necessary but this is how it was done:
rgns_bhi <- rgns_bhi %>%
 



Join dataframe with eez and subbasin ids as well



```{r}
rgns_bhi <- rgns_bhi %>%
   mutate(
    eez_nam   = str_split_fixed(rgns_bhi$rgn_nam, " - ", 2)[,1],
    basin_nam = str_split_fixed(rgns_bhi$rgn_nam, " - ", 2)[,2],) %>%
  left_join(regions_lookup %>%
              select(rgn_id = region_id, 
                     eez_id, 
                     basin_id = subbasin_id, # otherwise too long for shapefile header
                     area_km2 = area_km2_rgn),
            by = "rgn_id")
```


## Dissolve, i.e. group_by summarize

https://github.com/r-spatial/sf/issues/290

franconia %>% 
  group_by(district) %>% 
  summarise(m = mean(SHAPE_LEN)) %>% 
  st_cast() %>% 
  mapview(zcol = "m")


```{r}
## EEZs
rgns_eez <- rgns_bhi %>%
  group_by(eez_nam, eez_id) %>% 
  summarize(area_km2 = sum(area_km2)) # tried st_is_valid, all are valid

nrow(rgns_eez)
  
mapview::mapview(rgns_eez)

## SUBBASINS
rgns_subbasin <- rgns_bhi %>%
  group_by(basin_name, basin_id) %>% 
  summarize(area_km2 = sum(area_km2)) 

nrow(rgns_subbasin)
  
mapview::mapview(rgns_subbasin)
```

**Try to clean up errant lines**

There are a bunch of errant lines, but they are a part of the original shapefile. Try cleaning them up a bit, this didn't work

http://strimas.com/smoothr/reference/drop_crumbs.html
smoothr::drop_crumbs

http://data.bshc.pro/metadata/crs/
http://spatialreference.org/ref/epsg/3035/
```{r, eval=FALSE}
## this did not help so didn't save it as an object. Threshold setting is likely the problem: played around with many thresholds, crs, and can't change to km (always km^2)...
st_transform(rgns_subbasin, crs = 3035)
smoothr::drop_crumbs(rgns_subbasin, units::set_units(200, km2)) %>%
  mapview::mapview()
```

## Save shapefile

```{r}
## save EEZ
st_write(rgns_eez, dsn = dir_spatial, layer = "regions_EEZ", 
         driver = "ESRI Shapefile", update = TRUE, delete_layer = TRUE)

## save SUBBASIN
st_write(rgns_subbasin, dsn = dir_spatial, layer = "regions_SUBBASIN", 
         driver = "ESRI Shapefile", update = TRUE, delete_layer = TRUE)

```



## Plot

```{r}
# ggplot(rgns_bhi) +
#   geom_sf(aes(fill = rgn_id))
```

