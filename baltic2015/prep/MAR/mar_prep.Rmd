---
title: "MAR data layer prep"
output: html_document
---

## Data

Rainbow trout production  
Date were compiled by Ginnette Flores Carmenate

### Data sources
Data from country databases or reports  
Sweden
[Jorbruksverket] (http://www.scb.se/sv_/Hitta-statistik/Statistik-efter-amne/Jord--och-skogsbruk-fiske/Vattenbruk/Vattenbruk/)  

Denmark
[Danish Agrifish Agency (Ministry of Environment and Food of Denmark)]( http://agrifish.dk/fisheries/fishery-statistics/aquaculture-statistics/#c32851)  


Finland
[Natural Resources Institute](http://statdb.luke.fi/PXWeb/pxweb/fi/LUKE/LUKE__06%20Kala%20ja%20riista__02%20Rakenne%20ja%20tuotanto__10%20Vesiviljely/?tablelist=true&rxid=5211d344-451e-490d-8651-adb38df626e1)  

--Data were available as total marine production by region.  Data were also available as total production per fish species.  Rainbow trout dominated the total fish production.  Ginnette converted the total production by region to rainbow trout production by region by using the country wide percent rainbow trout of the marine production in each year.  (The other minor contributions to total production were European whitefish, Trout, other species, Roe of rainbow trout, roe of european whitefish).  

Sustainability Coefficient 
The SMI is the average of the three subindices traditionally used in the OHI framework. Trujillo's study included 13 subindices in total but only 3 of them are relevant for assessing the sustainability of mariculture : waster water treatment, usage of fishmeal and hatchery vs wild origin of seeds. Since Rainbow trout SMI is only included for Sweden. The mean value 5.3 was rescaled between 0-1 to 0.53. This value is then applied to Denmark and Finland.


### Production regions and BHI assignments
BHI regions were assigned to the country production reporting regions by Ginnette visually linking the two

### Data setup and load
These data are loaded by csv. Will need to update once data are in the database.  
This replaces earlier prep code because it starts with the raw data, rather than with data allocated

```{r setup and load data, echo =TRUE, message = FALSE, warning = FALSE}

#Libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)

##-------------------------##
## Read in data

lookup = read.csv("C:/Users/jgrif/Documents/StockholmUnivPostDoc/BalticHealthIndex/DataDownloads/Mariculture/mar_data_database/mar_data_lookuptable.csv",
                  header=TRUE,sep=";")
head(lookup)

production = read.csv("C:/Users/jgrif/Documents/StockholmUnivPostDoc/BalticHealthIndex/DataDownloads/Mariculture/mar_data_database/mar_data_production.csv",
                    header=TRUE,sep=";")
head(production)


```

### Plot the data by country's mar_region
This is the scale of data reported

```{r plot raw data, echo=TRUE}
ggplot(production)+geom_point(aes(year, production)) +
  facet_wrap(~mar_region, scales="free_y")

```


### Use mar_lookup to allocate production among BHI regions
Allocate data equally from mar_region to all associated BHI region.  
Do not have any additional information that would allow us to make this allocation based on known production distribution.

```{r allocated data by bhi region, echo=TRUE}

## create a conversion factor for each mar_region
lookup = lookup%>%
         group_by(mar_region)%>%
         mutate(rgn_factor = round((1/n_distinct(BHI)),2))%>%
         ungroup()


## join lookup to production

prod_allot = full_join(lookup, production, by=c("country","mar_region"))%>%
            select(mar_region,BHI, year, production, rgn_factor,common_name,ISSCAAP_FAO,Sust_coeff)%>%
            mutate(prod_allot = production*rgn_factor)%>%  #get production fraction for each BHI region
            select(-mar_region)%>%
            group_by(BHI,year,common_name,ISSCAAP_FAO, Sust_coeff)%>%
            summarise(prod_tot = sum(prod_allot,na.rm=TRUE))%>%  #get production per BHI region - more than one 
            ungroup()

```

### Plot production per BHI region

```{r plot production by bhi region, echo=TRUE}
ggplot(prod_allot)+geom_point(aes(year, prod_tot)) +
  facet_wrap(~BHI, scales="free_y")

```


### Create objects to save to put in layers, save a csv
3 layers: mar_harvest_tonnes, mar_harvest_species,mar_sustainability_score  

Regions with no data - BHI regions not associated with Sweden, Finland, and Denmark have no data.  This is because there is no production.  These regions should ultimately get a value of zero for their score to indicate there is no production but that the indicator is applicable.  

```{r output files for layers, echo=TRUE}
## mar_harvest_tonnes
mar_harvest_tonnes= prod_allot %>% select(BHI,ISSCAAP_FAO,year,prod_tot)%>%
                    dplyr::rename(rgn_id=BHI,species_code=ISSCAAP_FAO, year=year,tonnes=prod_tot)
head(mar_harvest_tonnes)
is.na(mar_harvest_tonnes$tonnes)

write.csv(mar_harvest_tonnes, "C:/Users/jgrif/Documents/github/bhi/baltic2015/layers/mar_harvest_tonnes_bhi2015.csv",row.names=FALSE)

## mar_harvest_species
mar_harvest_species= prod_allot %>%select(ISSCAAP_FAO,common_name)%>%
                    distinct(ISSCAAP_FAO,common_name)%>%
                    mutate(common_name=as.character(common_name))%>%
                    dplyr::rename(species_code=ISSCAAP_FAO, species=common_name)

write.csv(mar_harvest_species, "C:/Users/jgrif/Documents/github/bhi/baltic2015/layers/mar_harvest_species_bhi2015.csv",row.names=FALSE)


## mar_sustainability_score
mar_sustainability_score = prod_allot %>% select(BHI,common_name,Sust_coeff)%>%
                          mutate(common_name=as.character(common_name))%>%
                          distinct(.)%>%
                          dplyr::rename(rgn_id=BHI,species=common_name, sust_coeff=Sust_coeff)
  
write.csv(mar_sustainability_score, "C:/Users/jgrif/Documents/github/bhi/baltic2015/layers/mar_sustainability_score_bhi2015.csv",row.names=FALSE)

```


### Population density data
MAR code from OHI uses production/per capita  
This code creates a csv of the population density data (2005) from 25km inland buffer.  
Code in functions.r is where the decision is made whether or not to use it.
```{r population density, echo=TRUE}
##Code is commented out because connecting to the database prevents knitr from executing

#connect to the BHI database
#run your personal mysql config script to read in passcode

# con<-dbConnect(MySQL(),user=conf[,1],password=conf[,2],dbname="BHI_level_1",host=conf[,3], port=3306) # sets up the connection
# dbListTables(con) # shows all tables in the DB
# 
# #fetch GPD data from database, use BHI_relevant = 'NUTS3' should draw only NUTS3 data with is associated with a BHI region (database also contains some NUTS2)
# t<-dbSendQuery(con, paste("select * from AT_Pop_Density_BHI_inland_25km ;",sep="")) #BHI_relevant = 1 when geo\\time (NUTS3_ID) associated with 1 or more BHI_ID
# data<-fetch(t,n=-1) # loads selection and assigns it to variable 'data'
# head(data) #GPD data
# dbClearResult(t) # clears selection (IMPORTANT!)
# dbDisconnect(con) # closes connection (IMPORTANT!)
# 
# bhi_pop = data%>%select(BHI_ID, `Total Population in 25km Buffer`)%>%
#     rename(., rgn_id=BHI_ID, popsum=`Total Population in 25km Buffer`)
# bhi_pop

#write to layers folder to use in the function
#write.csv (bhi_pop,"C:/Users/jgrif/Documents/github/bhi/baltic2015/layers/mar_coastalpopn2005_inland25km_bh#i2015.csv",row.names=FALSE)


```
