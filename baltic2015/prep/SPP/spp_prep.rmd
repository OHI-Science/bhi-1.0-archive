---
title: "spp_prep"
output: github_document
params: 
    datasource: csv
---

## Preparation of SPP data layers
**For Biodiverity goal**

```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## source common libraries, directories, functions, etc
source('~/github/bhi/baltic2015/prep/common.r')

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))



dir_spp    = file.path(dir_prep, 'SPP')

## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_spp, 'spp_prep.rmd')

```

## 1. Background and Overview

### 1.1
"People value biodiversity in particular for its existence value. The risk of species extinction generates great emotional and moral concern for many people."

### 1.2 References
[Halpern et al. 2012. An index to assess the health and benefits of the global ocean. Nature 488: 615-620](http://www.nature.com/nature/journal/v488/n7413/full/nature11397.html)

[HELCOM Red List](http://www.helcom.fi/baltic-sea-trends/biodiversity/red-list-of-species) based on [IUCN criteria. ](http://www.iucnredlist.org/technical-documents/categories-and-criteria).  

**Threat categories**
*Evaluated species*
Extinct (EX)  
Regionally Extinct (RE)  
Extinct in the Wild (EW)  
Critically Endangered (CR)
Endangered (EN)  
Vulnerable (VU)  
Near Threatened (NT)  
Least Concern (LC)
Data Deficient (DD)
Not Applicable (NA)  
*Not-evaluated species*
Not Evaluated (NE)

## 2. Data Extraction and Prep
Two different data sources and goal calculation approaches are explored. 
**Option 1**  
HELCOM has spatial occurrence data layers for species and species are given an IUCN threat category.  
*Pros for using these data:*  
Data are spatially explicit, can score presence absence for each BHI region.  
*Cons for using these data:*  
These represent a very limited number of species in the Baltic (125 total) with the selection criteria being those with a spatial data layer in HELCOM. Many more species have been assessed using the IUCN criteria by HELCOM.  

**Option 2**
HELCOM provides species checklists for the Baltic that include distribution and a complete list of all species assessed with IUCN criteria.  
*Pros for using these data:*  
Much more representative set of species included for Baltic Sea biodiversity.  
*Cons for using these data:*  
Distribution is provided for most taxa groups at the basin scale - coaser resolution for calculation. Bird distribution is only by country (Germany has a couple of regions), therefore, will need additional expert information to allocate to basin or all bird species associated with a country will be allocated to all a country's BHI regions.  


### 2.1 Data sources and information for HELCOM spatial data
Data extraction and prep was done by Melanie Frazer

#### 2.1.1 Data Sources
Species coverage and threat level data were obtained from the [HELCOM Biodiversity Map Service](http://maps.helcom.fi/website/Biodiversity/index.html) under 'Biodiversity' and then under 'Red List'.  

Data were download in March 2016.  

#### 2.1.2 Data extraction
Different taxa groups have different file types (grid files, polygons). Each species has a threat level assigned. Melanie worked to align taxa and species to BHI regions and assign the vulnerability code.

Folders associated with these data are:  
- data  
- intermediate  
_ raw

Scripts associated with these data are:
- benthic_extract.R  
- bird_data_extract.R  
- fish_extract.R  
- macrophyte_extract.R  
- mammal_extract.R  
- taxa_combine.R  

Melanie's notes on the data extraction process are below. 

#### 2.1.3 Notes
#####  2.1.3.1 General Notes
**SPP data**
For groups on the HELCOM grid (benthos): there is a key (prep/spatial/helcom_to_rgn_bhi_sea.csv) that translates the grid cells into
baltic regions. The key was created using this script: prep/spatial/HELCOM_2_baltic.R.

For groups associated to HELCOM subbasin: this key was used to translate subbasins into baltic regions: prep/baltic_rgns_to_bhi_rgns_lookup_holas.csv

Helcom species data downloaded from here: http://maps.helcom.fi/website/Biodiversity/index.html
I added some subbasins to these data based on emails from Mar 21 email from Marc and Lena 
The data I added is incomplete.

The taxa_combine.R combines the 5 taxonomic groups: benthos, birds, fish, mammals, macrophytes into a single data frame.

To calculate the SPP score, the IUCN codes will be converted to numeric scores and then averaged within each region.

To calculate the ICO score, the species will be subset based on what is considered an iconic species and then the IUCN codes will be 
converted to numeric scores, and than averaged within each region.

#####  2.1.3.2 Benthic data

Weird thing: you can download a map for each species, but all the species are included in each file.  The
only difference is that there is a unique html downloaded from IUCN for the species in question.

These data are in the format of polygons that are functionally rasters.

The corresponding benthic dbf file is saved as csv: benthos_spatial_data.csv 

Painstakingly made a file to match the names in .shp file with the species names and vulnerability: benthic_species.csv

#####  2.1.3.3 Bird data 
There was no combined Helcom spatial file for birds (like there was for the benthic data).  

One complication was that some species had data in the format of the "raster-style" polygons.  While others were actual range polygons.

Given this, each bird spatial file was opened and then the range polygons were overlapped with the bhi regions.  

NOTE: one bird species fell out of the bhi polygon areas and was excluded. I would probably ignore....but it might be worth figuring out.

The spatial files downloaded from Helcom are located here: /var/data/ohi/git-annex/Baltic/spp/Birds

The script used to open each bird file and associate the polygons with BHI regions is: bird_data_extract.R

The extracted bird data is here: intermediate/birds.csv

#####  2.1.3.4 Mammal data
There is a combined file for mammals.  The ranges are described using polygons that relate to subbasins.

Some species have multiple IUCN categories (probably due to subspecies)
It would be ideal if we know which categories correspond to which regions, 
but these data are not available. 
two possible options are:
   1. average them
   2. use the most conservative option
I am going with #2 for now, but this would be easy to change (code in mammal_extract.R).
   
The script used to extract the data was: mammal_extract.R
The extracted mammal data are here: intermediate/mammals.R


#####  2.1.3.5 Fish data
There is a combined file for fish.  The range data are polygons that correspond to subbasins.


#####  2.1.3.6 Macrophyte data
N=17 datapoints fell outside the water.  This could probably be corrected by extracting the CELLCODES that land inland with some buffer.  
Don't know if this is worth the effort...


### 2.2 Data sources and information for checklist data

#### 2.2.1 Data sources
[HELCOM species checklists](http://helcom.fi/baltic-sea-trends/biodiversity/red-list-of-species) (see bottom right of page for links to excel sheets) were downloaded on 14 June 2016

Joni Kaitaranta (HELCOM) emailed the complete list of species assessed using IUCN red list criteria on 14 June 2016.

#### 2.2.2 Data folder
These data are in the folder 'SPP/data_checklist_redlist'  

#### 2.2.3 Data treatment for presence/absence  
Difference taxa groups had different levels and categorization of presence/absence.  This is what is included as presence for BHI from the checklist.  
*Breeding birds* presence = 'breeding'
*Fish* presence = 'regular reproduction' or 'regular occurence, no reproduction'  
*Macrophyte* presence = 'X'  
*Mammal* presence = 'X'  
*Invert* presence = 'X'  

#### 2.2.4 Other notes  
1. Breeding birds list noted species that used to be present but are extinct in a separate category - identified as 0
2. Fish are all occurrences since 1800 - so could have many temporary or extinct sp, Extinction not noted, exclude those labeled temporary.  
3. Macrophytes, Mammals, Inverts only have either X or blank.  
4. Macrophytes spp have many synonym names, manually combined so only the main latin name has all presence/absence occurences for all synonyms.  




## 3. Goal status and trend
BD goal will only be based on the SPP sub-component

### 3.1 Goal status
Xspp_r = 1- sum[wi]/R;  wi = threat weights for each species i, R = total number of species in BHI region r  
Ref pt = R (eg. score equals 1 when all species i have wi of LC)  
Scale min value = score is 0 when 75% of species are extinct.*  
*From Halpern et al 2012, SI. "We scaled the lower end of the biodiversity goal to be
0 when 75% species are extinct, a level comparable to the five documented mass extinctions"  

wi from Halpern et al 2012, SI
EX = 1.0  
CR = 0.8  
EN = 0.6  
VU = 0.4  
NT = 0.2  
LC = 0
DD = not included, "We did not include the Data Deficient classification as assessed species following previously published guidelines for a mid-point approach"  

**Will do above calculation for basin, not BHI region if use checklist distributions**


### 3.2 Goal trend
TBD  



# Two alternative data sources and status calculations follow.  Need to assess which is best.  

## 4. Spatial data data layer preparation

### 4.1 Data organization

#### 4.1.1 Read in species data
```{r read in species data}
## read in data...
data = read.csv(file.path(dir_spp, 'data/species_IUCN.csv'))
dim(data)
str(data)
```

#### 4.1.2 Set up vulnerability code
```{r vulnerability codes}

vuln_lookup = data %>%
              select(IUCN)%>%
              distinct(.) %>% ## unique vulnerability codes
              mutate(IUCN_numeric = ifelse(IUCN == 'EX',1,
                                    ifelse(IUCN == 'CR',0.8,
                                    ifelse(IUCN == 'EN', 0.6,
                                    ifelse(IUCN == 'VU', 0.4,
                                    ifelse(IUCN == 'NT', 0.2,
                                    ifelse(IUCN == 'LC',0,NA))))))) ## DD will receive NA
vuln_lookup ## note, no species with EX

```

#### 4.1.3 Join numeric vulnerability code to species
```{r join numeric vulnerability}

data2 = data %>%
        left_join(.,vuln_lookup, by= "IUCN")
head(data2)

```

#### 4.1.4 Plot by region
```{r plot raw by region}
ggplot(data2)+
  geom_point(aes(rgn_id, species_name),size=1)+
  facet_wrap(~IUCN)+
  theme(axis.text.y = element_text(colour="grey20", size=2, angle=0, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle ("Species presence and vulnerability by region")


ggplot(data2)+
  geom_point(aes(rgn_id, species_name, colour=taxa),size=1)+
  facet_wrap(~IUCN)+
  theme(axis.text.y = element_text(colour="grey20", size=2, angle=0, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle ("Species presence and vulnerability by region")

```

#### 4.1.5 Distribution in IUCN categories
Benthos & macrophytes have many more DD
```{r distribution in IUCN categories}
## how many in each category from each taxa group?
percent_vuln = data2 %>% 
  select(-rgn_id)%>%
  distinct()%>%
  select(IUCN,taxa) %>% 
  count(taxa,IUCN) %>%
  group_by(taxa)%>%
  mutate(n_tot = sum(n))%>%
  ungroup()%>%
  mutate(percent = round(n/n_tot,2)*100)%>%
  print(n=24)

ggplot(percent_vuln, aes(x=taxa, y=percent, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Percent of species in each IUCN category")

```

#### 4.1.6 Total number of species in each taxa group by IUCN categroy
```{r number of species in each taxa group}

ggplot(percent_vuln, aes(x=taxa, y=n, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Number of species in each IUCN category")



ggplot(filter(percent_vuln, IUCN != "DD"), aes(x=taxa, y=n, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Number of species in each IUCN category without DD")


```


#### 4.1.7 Remove DD species
Species given DD are not included. See methods above and in Halpern et al. 2012  

Benthos has a much larger number of species in DD category
```{r remove DD}

data3 = data2 %>%
        filter(IUCN != "DD")
dim(data3);dim(data2)

```

#### 4.1.8 Check for duplicates
```{r check for duplicates}
data3 %>% nrow() #2205
data3 %>% distinct() %>% nrow() #2096

## appears to be duplicates

##remove duplicates by selecting the distinct columns
data3 = data3 %>% 
        arrange(rgn_id,species_name) %>%
        distinct()
        
dim(data3) #2096

```

#### 4.1.7 Export Species list 
Export species list to be check to see if sufficient coverage
```{r export species list}
species_list = data3 %>%
              select(species_name,taxa)%>%
              distinct(.)
dim(species_list) #125  1

write.csv(species_list, file.path(dir_spp,'species_list_included.csv'), row.names=FALSE)


```


### 4.2 Data layer for functions.r
```{r data layer for functions.r}
data3 = data3 %>%
        select(rgn_id, species_name, IUCN_numeric) %>%
        dplyr::rename(weights = IUCN_numeric)
##write.csv(data3, file.path(dir_layers, 'spp_div_vuln_bhi2015.csv'), row.names=FALSE)

```

### 4.3 Status calcalculation

#### 4.3.1 Calculate status
```{r status calculation}
##sum the weights for each BHI region
sum_wi = data3 %>%
         group_by(rgn_id)%>%
         summarise(sum_wi =sum(weights))%>%
         ungroup()
dim(sum_wi)

## count the number of species in each BHI region
sum_spp = data3 %>%
          select(rgn_id, species_name)%>%
          dplyr::count(rgn_id)
dim(sum_spp)


data3%>% filter(rgn_id== 1) %>% nrow() ## check to make sure works
head(sum_spp)

spp_status = full_join(sum_wi,sum_spp, by="rgn_id") %>%
             mutate(wi_spp = sum_wi/n,
                    status = 1 - wi_spp)
               

```

#### 4.3.2 Scale lower end to zero if 75% extinct
Currently, no species labeled extinct but will set up code in case used in the future

```{r scale for 75 percent extinct}
## calculate percent extinct in each region
spp_ex = data3 %>% 
         filter(weights == 1)
spp_ex
## No species extinct
## IF spp are extinct, find % extinct out of total number of species for each region; join to the status calculation; set regions with 75% or more extinct to a score of 0

```

#### 4.3.3 Plot status
```{r plot spp status}
## Plot status
ggplot(spp_status)+
  geom_point(aes(rgn_id,round(status*100)),size=3)+
  ylim(0,100)+
  ylab("Status") + 
  xlab("BHI region")+
  ggtitle("SPP status by BHI region")

## Size points to number of species in a region
ggplot(spp_status)+
  geom_point(aes(rgn_id,round(status*100), size=n))+
  ylim(0,100)+
  ylab("Status") + 
  xlab("BHI region")+
  ggtitle("SPP status by BHI region, n= species richness")

```



## 5. Data layer preparation with checklist distribution data

### 5.1 Data organization

#### 5.1.1 Read in data

```{r read in checklist and redlist}

bbirds = read.csv(file.path(dir_spp,'data_checklist_redlist/breedingbirds_dist_checklist.csv'), sep= ";", stringsAsFactors = FALSE)

fish = read.csv(file.path(dir_spp,'data_checklist_redlist/fish_dist_checklist.csv'), sep= ";", stringsAsFactors = FALSE)

invert = read.csv(file.path(dir_spp,'data_checklist_redlist/invert_dist_checklist.csv'), sep= ";", stringsAsFactors = FALSE)

macrophytes = read.csv(file.path(dir_spp,'data_checklist_redlist/macrophytes_dist_checklist.csv'), sep= ";", stringsAsFactors = FALSE)

mammals = read.csv(file.path(dir_spp,'data_checklist_redlist/mammals_dist_checklist.csv'), sep= ";", stringsAsFactors = FALSE)


redlist = read.csv(file.path(dir_spp,'data_checklist_redlist/helcom_redlist_allspecies.csv'), sep= ";", stringsAsFactors = FALSE)


```

#### 5.1.2 Data structure

```{r data structure}
str(bbirds)
str(fish)
str(invert)
str(macrophytes)
str(mammals)

str(redlist)
```

#### 5.1.3 Translate code to presence/absence
Objective is to get a data layer of current species occurence.  

Each taxa group has a different code for noting distribution in different regions. Translate to a 1 or 0 for presence absence then gather to long format

##### 5.1.3.1 Breeding birds
X = breeding  
(X) = sporadic breeding (only occasional breeding records)  
0 = 	extinct (breeding in the past, but no actual breeding records)  
0	= sporadic breeder in the past, no breeding records during the last 3 generations or 10 years  
0(X) =	extinct as a regular breeder, but sporadic breeding records during the last 3 generations or 10 years  
-	= no breeding birds  

**For BHI:** *X = 1* and *all others = 0*  

```{r bbirds cleaning}
## gather birds to long format
bbirds_long = bbirds %>%
              gather(location,presence,-latin_name,-common_name)%>%
              mutate(presence = ifelse(presence == "X", 1, 0))%>% ##change X to present (1) all else absent (0)
              mutate(taxa_group = "breeding birds")

```


##### 5.1.3.2 Fish and Lamprey
R =	regular reproduction  
X	 = regular occurrrence, no reproduction  
T	= temporary occurrence  
?	= occurrance uncertain  

**For BHI:** *R or X = 1* and *T or ? = 0*  
```{r clean fish data}
## clean up fish data (had ? not removed), gather to long format
fish_long = fish %>%
            mutate(latin_name =str_replace(latin_name,"\\*",""))%>% ## remove * at end of latin name
            gather(location,presence,-latin_name,-common_name)%>%
            mutate(presence = ifelse(presence == "R", 1, 
                              ifelse(presence == "X", 1, 0)))%>%
            mutate(taxa_group = "fish")
  
```

##### 5.1.3.3 Invertebrates
X	= ocurrance  
'blank' =	no occurance  

**For BHI:** *X = 1* and *blank = 0* 

```{r clean invert}
      
## gather invert  to long format
invert_long = invert %>%
              gather(location,presence,-latin_name,-common_name)%>%
              mutate(presence = ifelse(presence == "X", 1, 0))%>% 
              mutate(taxa_group = "invert")

```

##### 5.1.3.4 Macrophytes
1 = 	occurance
0 = no occurance
uncertain = had a note in checklist about checking the distribution  
**For BHI:** *X = 1* and *0 and uncertain = 0*  
```{r clean macrophytes}
##gather macrophytes to long format
macrophytes_long = macrophytes %>%
                    gather(location,presence,-latin_name,-common_name)%>%
                    mutate(presence = ifelse(presence == "uncertain", 0, presence),
                           presence = as.numeric(presence))%>% 
                    mutate(taxa_group = "macrophytes")

```

##### 5.1.3.5 Mammals
X	= ocurrance  
'blank' = no occurance  

**For BHI:** *X = 1* and *blank = 0* 

```{r clean mammals}

##gather mammals to long format
mammals_long = mammals %>%
               gather(location,presence,-latin_name,-common_name)%>%
               mutate(presence = ifelse(presence == "x", 1, 0))%>% 
               mutate(taxa_group = "mammals")

```

### 5.2 Data attributes

#### 5.2.1 Get number of species by taxa group
2731 total unique latin names  
```{r species and taxa group checklist}

species_checklist = bind_rows(select(bbirds_long,latin_name,taxa_group),
                         select(fish_long,latin_name,taxa_group),
                         select(invert_long,latin_name,taxa_group),
                         select(macrophytes_long,latin_name,taxa_group),
                         select(mammals_long,latin_name,taxa_group))%>%
                         distinct()

species_checklist_n = species_checklist %>%
                      count(taxa_group)

ggplot(species_checklist, aes(x=taxa_group))+
   geom_bar(stat="count")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in the checklist")

## number of unique latin names
species_checklist %>% select(latin_name)%>%distinct()%>%nrow() #2731

##add list_type
species_checklist = species_checklist%>%
                    mutate(list_type = "checklist")

```


#### 5.2.2 Get number of species by taxa group on the red list
2772 on redlist  
Need to see how many are assessed. 
```{r number species redlist}
str(redlist)

ggplot(redlist, aes(x=taxa_group))+
   geom_bar(stat="count")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in the redlist")

## number of unique latin names
redlist %>% select(latin_name)%>%distinct()%>%nrow() #2772

## add list_type column

redlist = redlist %>%
          mutate(list_type = "redlist")

```


#### 5.2.3 Get a species list that is all those present on the red list and check list
1. First join and retain all species to see if spelling causes any mismatches.  
2. Retain only species on both lists, join by taxa group and latin name.

**What is not present**
*Not on Redlist*
343 species on checklist not on redlist.  
1. No wintering birds in the checklist.  

##### 5.2.3.1 Full species list
```{r full species list}
full_species = full_join(species_checklist,redlist, by=c("latin_name","taxa_group"))%>%
                  select(-iucn_criteria)%>%
                  mutate(helcom_category = as.character(helcom_category))
dim(full_species) #3152   6

##which species are not on both lists?

  #          

            
```
##### 5.2.3.2 on checklist not redlist
Ringed seal latin name differs - correct in redlist to *Pusa hispida*  
4 breeding birds not on redlist --spelling differences, correct on redlist  
310 macrophytes not on redlist  
28 invertebreates not on redlist  
```{r species on checklist not redlist }
# which are in checklist but not redlist
      full_species %>% filter(is.na(list_type.y)) %>%nrow()  ##343
      full_species %>% filter(is.na(list_type.y)) %>%select(taxa_group)%>%distinct()  ## breeding birds, invert, macrophytes mammals

## check mammals
   full_species %>% filter(is.na(list_type.y)) %>% filter(taxa_group =="mammals") #Pusa hispida  
          
   redlist %>% filter(taxa_group == "mammals") ##Phoca hispida botnica 
    
   mammals %>% select(latin_name,common_name)
   
## check breeding birds
   full_species %>% filter(is.na(list_type.y)) %>% filter(taxa_group =="breeding birds")
  
    redlist %>% filter(grepl("Actitis", latin_name)) ## look for Actitis hypoleucos 
    
    redlist %>% filter(grepl("Larus",latin_name))#Larus minutus (Hydrocoloeus minutus) ##Larus ridibundus (Chroicocephalus ridibundus) 

    redlist %>% filter(grepl("Mergus",latin_name)) ##Mergus albellus (Mergellus albellus) 
          
          
## Check macrophytes
           full_species %>% filter(is.na(list_type.y)) %>% filter(taxa_group =="macrophytes") ##310 species
           
## check inverts
            full_species %>% filter(is.na(list_type.y)) %>% filter(taxa_group =="invert") ##28 species


            
#### UPDATE NAMES ON REDLIST
redlist = redlist %>%
      mutate(latin_name = ifelse(latin_name=="Phoca hispida botnica","Pusa hispida",latin_name),
      latin_name = ifelse(latin_name== "Actitis hypoleucos (Linnaeus, 1758)","Actitis hypoleucos",latin_name),
       latin_name = ifelse(latin_name == "Larus minutus", "Larus minutus (Hydrocoloeus minutus)", latin_name),
             latin_name = ifelse(latin_name == "Larus ridibundus","Larus ridibundus (Chroicocephalus ridibundus)",latin_name),
             latin_name = ifelse(latin_name =="Mergellus albellus" ,"Mergus albellus (Mergellus albellus)",latin_name))


  
### REJOIN objects
            
full_species = full_join(species_checklist,redlist, by=c("latin_name","taxa_group"))%>%
                  select(-iucn_criteria)%>%
                  mutate(helcom_category = as.character(helcom_category))
dim(full_species) #3147   6
              
```

##### 5.2.3.3 on redlist not on checklist  
**410 species on redlist not on checklist **
1. 63 species of wintering birds. There is no wintering birds checklist so just use breeding birds and the threat level assigned to species in breeding birds (even if a species is listed on redlist in both breeding and wintering)  
2. 9 species of fish. Not found - but perhaps smelt is simply incorrect on redlist (*Osmerus eperlanomarinus*) and should be changed to *Osmerus eperlanus* which is on the checklist?  

```{r redlist not on checklist}
## Species on redlist not on checklist
         full_species %>% filter(is.na(list_type.x)) %>%nrow()  ##   410
         full_species %>% filter(is.na(list_type.x)) %>%select(taxa_group)%>%distinct()  ## macrophytes, invert, wintering birds, fish

## check wintering birds - 63 wintering birds.  There is no checklist for wintering birs. Will use the breeding birds and their associated threat level.
   full_species %>% filter(is.na(list_type.x)) %>% filter(taxa_group =="wintering birds")

   
##check fish 
    full_species %>% filter(is.na(list_type.x)) %>% filter(taxa_group =="fish") ## 9 spp
    
    ##search checklist
    species_checklist %>% filter(grepl("Coregonus", latin_name)) ##look for  Coregonus balticus & Coregonus pallasii 
            ##fishbase.org say C. pallasii is found in large lakes
   species_checklist %>% filter(grepl("Lophius", latin_name)) ## Lophius budegassa
   species_checklist %>% filter(grepl("Osmerus", latin_name)) ## Osmerus eperlanomarinus
              ##equivalent (smelt)? - search fishbase.org for Osmerus eperlanomarinus and returns Osmerus eperlanus
   species_checklist %>% filter(grepl("Hexanchus", latin_name)) ## Hexanchus griseus  
   species_checklist %>% filter(grepl("Raja", latin_name)) ## Raja montagui (Spotted ray )
   species_checklist %>% filter(grepl("Acipenser", latin_name)) ## Acipenser sturio
   species_checklist %>% filter(grepl("Orcynopsis", latin_name)) ## Orcynopsis unicolor
   species_checklist %>% filter(grepl("Sphyrna", latin_name)) ## Sphyrna zygaena 
    
   
```

#### 5.2.4 shared species object
2393 unique species shared between the species checklist and the red list
```{r shared species object}
#
## object of only species shared betweent the lists  
shared_species = full_species %>%
                  filter(!is.na(list_type.x) & !is.na(list_type.y))
dim(shared_species)

shared_species %>% select(latin_name)%>%distinct() %>% nrow()##2393

```


##### 5.2.4.1 Duplicates in shared_species
Cod are assessed at the species level, and by subpopulation. Harbor porpoise and Harbor seal also have assessments by subpopulation.  Invert Malacoceros fuliginosus has 2 threat assessments at the species level.

** For Cod - there is a species level assessment and so use this -  VU**
**For *Malacoceros fuliginosus* there are two species level assessments, one LC, one NE - select LC**
**For *Phoca vitulina vitulina* and *Phocoena phocoena* select highest threat for each, VU and CR respectively**
```{r duplicates in shared_species}
## are there species with more than one helcom_cateogry threat?
shared_species %>% select(latin_name,helcom_category)%>%distinct()%>%nrow()
##[1] 2298
shared_species %>% select(latin_name)%>%distinct()%>%nrow()
##2393

##YES

##which are duplicated
shared_species %>% select(latin_name)%>% filter(duplicated(.)==TRUE)

shared_species %>% filter(latin_name== "Gadus morhua" | latin_name== "Malacoceros fuliginosus" | latin_name=="Phoca vitulina vitulina" | latin_name=="Phocoena phocoena") 

## select the species assessment

shared_species = shared_species%>%
                 mutate(helcom_category = ifelse(latin_name == "Gadus morhua", "VU",
                                           ifelse(latin_name == "Malacoceros fuliginosus", "LC",
                                           ifelse(latin_name == "Phoca vitulina vitulina" ,"VU",
                                           ifelse(latin_name == "Phocoena phocoena","CR",helcom_category)))))%>%
                 select(-assessment_unit)%>%
                 distinct()
## check for duplicates
shared_species %>% select(latin_name,helcom_category)%>%distinct()%>%nrow();shared_species %>% select(latin_name)%>%distinct()%>%nrow()

                 
```


#### 5.2.5 Plot the shared_species list by threat category
```{r plot shared_species by threat}

shared_species_threat_n = shared_species %>%
                       count(taxa_group,helcom_category)

ggplot(shared_species_threat_n, aes(x=taxa_group, y=n, fill=helcom_category))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species in each IUCN category")

```

### 5.3 Select data for analysis
#### 5.3.1 Exclude taxa that are:
1. Data decificient (DD)
2. Not Evaluated  (NE)
```{r exclude DD and NE from shared_species}
## save excluded species in separate object
shared_species_dd_ne = bind_rows(filter(shared_species,helcom_category == 'DD'),
                                 filter(shared_species,helcom_category == 'NE'))
str(shared_species_dd_ne)
dim(shared_species_dd_ne)# 729 5

## plot excluded
shared_species_dd_ne_threat_n = shared_species_dd_ne %>%
                       count(taxa_group,helcom_category)

ggplot(shared_species_dd_ne_threat_n, aes(x=taxa_group, y=n, fill=helcom_category))+
  geom_bar(stat="identity")+
  ggtitle("Count of excluded species ")



##object excluding DD and NE
shared_species2 = bind_rows(filter(shared_species,helcom_category == 'NT'),
                            filter(shared_species,helcom_category == 'LC'),
                            filter(shared_species,helcom_category == 'VU'),
                            filter(shared_species,helcom_category == 'EN'),
                            filter(shared_species,helcom_category == 'CR'),
                            filter(shared_species,helcom_category == 'RE'),
                            filter(shared_species,helcom_category == 'NA'))
                            
                                 
dim(shared_species2); dim(shared_species) # 1474,2393 


## recreate object without DD and NE
shared_species_threat_n = shared_species2 %>%
                       count(taxa_group,helcom_category)

ggplot(shared_species_threat_n, aes(x=taxa_group, y=n, fill=helcom_category))+
  geom_bar(stat="identity")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species in each IUCN category")


```


### 5.4 Score threat level
#### 5.4.1 Repeat making the vuln_lookup
Add category Regionally Extinct, and score same as Extinct
```{r repeat vuln_lookup}

## repeat code from section 4, vulnerability lookup table


vuln_lookup = shared_species2 %>%
              select(helcom_category)%>%
              distinct(.) %>% ## unique vulnerability codes
              mutate(helcom_category_numeric = ifelse(helcom_category == 'EX',1,
                                    ifelse(helcom_category == 'RE',1,
                                    ifelse(helcom_category == 'CR',0.8,
                                    ifelse(helcom_category == 'EN', 0.6,
                                    ifelse(helcom_category == 'VU', 0.4,
                                    ifelse(helcom_category == 'NT', 0.2,
                                    ifelse(helcom_category == 'LC',0,NA)))))))) ## 


vuln_lookup ## note, no species with EX

```

#### 5.4.2 Join the vulnerability score to the shared species list

```{r  join vuln to shared_species2}

shared_species3 = shared_species2 %>%
                  left_join(., vuln_lookup, by="helcom_category")

```


### 5.5 Species distributions

#### 5.5.1 Basin names used for distribution
Major basin are the same but smaller regions also included, these differ in number
```{r basin names used for distribution}

fish_loc = fish_long %>% select(location)%>%arrange()%>%distinct() %>%
  mutate(location = ifelse(location == "Åland.Sea", "Aland.Sea",location))##21
invert_loc = invert_long %>% select(location)%>%arrange()%>%distinct() ##32
macrophytes_loc = macrophytes_long %>% select(location)%>%arrange()%>%distinct() ##17
mammals_loc = mammals_long %>% select(location)%>%arrange()%>%distinct()%>%
              mutate(location = ifelse(location == "Åland.Sea", "Aland.Sea",location))##19
```

#### 5.5.2 Location name object
```{r basin name object}
dist_loc = bind_rows(fish_loc,invert_loc,macrophytes_loc,mammals_loc)%>%
            arrange()%>%
            distinct()
## Export location object, clean in excel and reimport
#write.csv(dist_loc, file.path(dir_spp,'distribution_locations.csv'), row.names=FALSE)

## Read in csv with HOLAS basin names added to the distribution locations
dist_loc = read.csv(file.path(dir_spp,'distribution_locations.csv'),sep=";")

##number of basin
dist_loc %>% select(basin)%>%distinct()%>%nrow() #17 ## These match HOLAS basins


```

#### 5.5.3 Join dist_loct to taxa checklists  
This excludes birds because distribution given by country.  
```{r  checklist_distribution}

species_dist = bind_rows(fish_long,
                         invert_long,
                         macrophytes_long,
                         mammals_long)%>%
              full_join(., dist_loc, by="location")

str(species_dist)
```


### 5.6 Species distributions + Threat score
```{r join species_dist to shared_species3 }

## number of species that should be on final list is
shared_species3 %>% nrow() ## 1474 species should be on the final list


## join shared_species3 to species_dist
shared_species_dist = left_join(shared_species3, species_dist, 
                                by=c("latin_name","taxa_group")) %>%
                      select(-list_type.x, -list_type.y,-location)%>%  ## exclude location because may have more than one location per basin
                      select(taxa_group,latin_name,common_name,helcom_category,helcom_category_numeric,basin,presence) %>%
                      distinct()%>%
                      arrange(taxa_group, latin_name)


dim(shared_species_dist)
shared_species_dist %>% select(latin_name)%>% distinct() %>% nrow() #1474

```

### 5.6.1 Plot IUCN category by taxa and basin
Breeding birds were distributed by country so no basin assignment currently.  
```{r}


## recreate object without DD and NE
shared_species_dist_n = shared_species_dist %>%
                       count(basin,taxa_group,helcom_category)

ggplot(shared_species_dist_n, aes(x=taxa_group, y=n, fill=helcom_category))+
  geom_bar(stat="identity")+
  facet_wrap(~basin, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species in each IUCN category")




```

### 5.7 Status calculation by basin
Data are on the HOLAS basin scale. Calculate biodiversity status by basin and then apply to BHI regions.  
*Note, this will mean that the data layer sent to layers and what is registered in layers.csv is very different than what is done if use the spatial data layers from HELCOM where status is directly calculated for BHI regions and this is done formally in functions.r*  

### 5.7.1 Calulate SPP status using checklist and redlist data with all species weighted equally
**Exclude birds for now**  
Do a single calculation including all species. Will compare this result to doing this calculation first for each taxa group and then taking the geometric mean (See Section 6.7.2)

##### 5.7.1.1 Calculate status
```{r status calculation for checklist and redlist data}
##sum the threat weights for each basin
sum_wi_basin =shared_species_dist %>%
              filter(taxa_group != "breeding birds")%>% ## remove birds
              select(basin,helcom_category_numeric)%>%
              dplyr::rename(weights=helcom_category_numeric)%>%
              group_by(basin)%>%
              summarise(sum_wi =sum(weights))%>%
              ungroup()
dim(sum_wi_basin) #17 2

## count the number of species in each BHI region
sum_spp_basin = shared_species_dist %>%
                filter(taxa_group != "breeding birds")%>% ## remove birds
                filter(presence != 0) %>% # select only present taxa
                select(basin, latin_name)%>%
                dplyr::count(basin)
dim(sum_spp_basin) #17 2


shared_species_dist%>% filter(basin== "Aland Sea") %>% nrow() ## check to make sure works
head(sum_spp_basin)

spp_status_basin = full_join(sum_wi_basin,sum_spp_basin, by="basin") %>%
             mutate(wi_spp = sum_wi/n,
                    status = 1 - wi_spp)
               

```

##### 5.7.1.2 Scale lower end to zero if 75% extinct
Currently, species are labled regionally extinct 

```{r scale for 75 percent extinct for basin}
## calculate percent extinct in each region
spp_ex_basin = shared_species_dist %>%
              filter(taxa_group != "breeding birds")%>% 
              filter(presence != 0) %>% # select only present taxa
              dplyr::rename(weights=helcom_category_numeric)%>%## remove birds
              filter(weights == 1)
spp_ex_basin

## which are RE (regionally extinct)
spp_ex_basin %>% select(latin_name,common_name)%>%distinct() ##2 


##total extinct per basin

spp_ex_basin_n = spp_ex_basin %>%
                  select(basin,latin_name)%>%
                  dplyr::count(basin)%>%
                  dplyr::rename(n_extinct = n)


## join to basin status
spp_status_basin = spp_status_basin %>%
                   full_join(.,spp_ex_basin_n, by="basin") %>%
                   mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

## calculated the % extinct in each basin. if >75% then status score is 0
spp_status_basin = spp_status_basin %>%
                  mutate(prop_extinct = n_extinct / n,
                         status = ifelse(prop_extinct>=0.75, 0, status))

```

##### 5.7.1.3 Plot status by basin
```{r plot basin status}
## Plot status
ggplot(spp_status_basin)+
  geom_point(aes(basin,round(status*100)),size=3)+
  ylim(0,100)+
  ylab("Status") + 
  xlab("Basin")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("SPP status by Basin")

## Size points to number of species in a region
ggplot(spp_status_basin)+
  geom_point(aes(basin,round(status*100), size=n))+
  ylim(0,100)+
  ylab("Status") + 
  xlab("Basin")+
  scale_size(breaks =c(1200,1400,1600,1800), labels=c("1200","1400","1600","1800"))+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP status by Basin, n= species richness")



```

### 5.7.2 Calulate SPP status using checklist and redlist data by taxa group and geometric mean
**Exclude birds for now**  
Calculation status by taxa group by basin and then taking the geometric mean for each basin.

##### 5.7.2.1 Calculate status by taxa group
```{r taxa group status calculation for checklist and redlist data}
##sum the threat weights for each basin by taxa group
sum_wi_basin_taxa_group =shared_species_dist %>%
              filter(taxa_group != "breeding birds")%>% ## remove birds
              select(basin,taxa_group,helcom_category_numeric)%>%
              dplyr::rename(weights=helcom_category_numeric)%>%
              group_by(basin, taxa_group)%>%
              summarise(sum_wi =sum(weights))%>%
              ungroup()
dim(sum_wi_basin_taxa_group) #68  3

## count the number of species in each BHI region by taxa group
sum_spp_basin_taxa_group = shared_species_dist %>%
                filter(taxa_group != "breeding birds")%>% ## remove birds
                filter(presence !=0) %>% ## filter out species not present
                select(basin, taxa_group,latin_name)%>%
                dplyr::count(basin, taxa_group)
dim(sum_spp_basin_taxa_group) #68 3


spp_status_basin_taxa_group = full_join(sum_wi_basin_taxa_group,
                                        sum_spp_basin_taxa_group, by=c("basin","taxa_group")) %>%
             mutate(wi_spp_taxa = sum_wi/n,
                    status_taxa = 1 - wi_spp_taxa)
               

```

##### 5.7.2.2 Plot status by taxa group
```{r plot taxa_group Status}
ggplot(spp_status_basin_taxa_group)+
  geom_point(aes(taxa_group,status_taxa,size=n))+
  facet_wrap(~basin) +
  ylim(0,1.5)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("Taxa group Status by Basin, n= species richness")


```


##### 5.7.2.3 For each taxa group - Scale lower end to zero if 75% extinct
Currently, species are labled regionally extinct 

```{r scale for each taxa group if 75 percent extinct for basin}
## calculate percent extinct in each region
spp_ex_basin_taxa_group = shared_species_dist %>%
              filter(taxa_group != "breeding birds")%>% 
              filter(presence != 0) %>% # select only present taxa
              dplyr::rename(weights=helcom_category_numeric)%>%## remove birds
              group_by(taxa_group)%>%
              filter(weights == 1)%>%
              ungroup()
spp_ex_basin_taxa_group

## which are RE (regionally extinct)
spp_ex_basin_taxa_group %>% select(latin_name,common_name)%>%distinct() ##2 


##total extinct per basin

spp_ex_basin_n_taxa_group = spp_ex_basin_taxa_group %>%
                  select(basin, taxa_group,latin_name)%>%
                  dplyr::count(basin,taxa_group)%>%
                  dplyr::rename(n_extinct = n)


## join to basin status
spp_status_basin_taxa_group = spp_status_basin_taxa_group %>%
                   full_join(.,spp_ex_basin_n_taxa_group, by=c("basin", "taxa_group")) %>%
                   mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

## calculated the % extinct in each basin. if >75% then status score is 0
spp_status_basin_taxa_group  = spp_status_basin_taxa_group  %>%
                  mutate(prop_extinct = n_extinct / n,
                         status_taxa = ifelse(prop_extinct>=0.75, 0, status_taxa))

```

##### 5.7.2.4 Plot again status by taxa group
```{r plot taxa_group Status again}
ggplot(spp_status_basin_taxa_group)+
  geom_point(aes(taxa_group,status_taxa,size=n))+
  facet_wrap(~basin) +
  ylim(0,1.5)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("Taxa group Status by Basin, n= species richness")


```


##### 5.7.2.5 Calculate Geometric Mean for Basin status
```{r geometric mean for basin status}
spp_status_basin_geo = spp_status_basin_taxa_group %>%
                        select(basin, status_taxa) %>%
                       group_by(basin)%>%
                       summarise(status_basin =exp(mean(log(status_taxa))))%>%
                        ungroup()

```

##### 5.7.2.4 Plot Geometric Mean for Basin status
```{r plot basin Status from geometric mean}
ggplot(spp_status_basin_geo)+
  geom_point(aes(basin, status_basin),size=2)+
  ylim(0,1)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP Basin status from geometric mean of taxa group status")


```

#### 5.7.3 Compare alternative approaches to Basin level SPP status calculation

```{r comparsion of basin level spp status}
spp_status_basin = spp_status_basin %>%
                    select(basin,status)%>%
                    mutate(status_type = "all species")
spp_status_basin_geo = spp_status_basin_geo %>%
                        dplyr::rename(status=status_basin)%>%
                        mutate(status_type = "taxa group geometric mean")

basin_status_compare = bind_rows(spp_status_basin,spp_status_basin_geo)


ggplot(basin_status_compare)+
  geom_point(aes(basin, status, colour=status_type,shape=status_type),size=2)+
  ylim(0,1)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP Basin status method comparision")


```

## TO DO
1. Apply basin scores to BHI regions  
2. Send data layer to layers  
3. Update functions.r if using the checklist and redlist data  
4. Decide how to deal with birds that have spatial dist by country (not basin)  
5. Decide if it is a problem that status is dominated by inverts with LC  
6. check to see if any invasives included in the species list  
7. How to calculate a trend?  

