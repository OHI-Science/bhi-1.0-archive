---
title: "spp_prep"
output: github_document
params: 
    datasource: csv
---

## Preparation of SPP data layers
**For Biodiverity goal**

```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## source common libraries, directories, functions, etc
source('~/github/bhi/baltic2015/prep/common.r')

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))



dir_spp    = file.path(dir_prep, 'SPP')

## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_spp, 'spp_prep.rmd')

```

## 1. Background and Overview

### 1.1
"People value biodiversity in particular for its existence value. The risk of species extinction generates great emotional and moral concern for many people."

### 1.2 References
[Halpern et al. 2012. An index to assess the health and benefits of the global ocean. Nature 488: 615-620](http://www.nature.com/nature/journal/v488/n7413/full/nature11397.html)

[HELCOM Red List](http://www.helcom.fi/baltic-sea-trends/biodiversity/red-list-of-species) based on [IUCN criteria. ](http://www.iucnredlist.org/technical-documents/categories-and-criteria).  

## 2. Data Extraction and prep
Data extraction and prep was done by Melanie Frazer

### 2.1 Data Sources
Species coverage and threat level data were obtained from the [HELCOM Biodiversity Map Service](http://maps.helcom.fi/website/Biodiversity/index.html) under 'Biodiversity' and then under 'Red List'.  

Data were download in March 2016.  

### 2.2 Data extraction
Different taxa groups have different file types (grid files, polygons). Each species has a threat level assigned. Melanie worked to align taxa and species to BHI regions and assign the vulnerability code.

Melanie's notes on the data extraction process are below. 

####  2.2.1 General Notes
**SPP data**
For groups on the HELCOM grid (benthos): there is a key (prep/spatial/helcom_to_rgn_bhi_sea.csv) that translates the grid cells into
baltic regions. The key was created using this script: prep/spatial/HELCOM_2_baltic.R.

For groups associated to HELCOM subbasin: this key was used to translate subbasins into baltic regions: prep/baltic_rgns_to_bhi_rgns_lookup_holas.csv

Helcom species data downloaded from here: http://maps.helcom.fi/website/Biodiversity/index.html
I added some subbasins to these data based on emails from Mar 21 email from Marc and Lena 
The data I added is incomplete.

The taxa_combine.R combines the 5 taxonomic groups: benthos, birds, fish, mammals, macrophytes into a single data frame.

To calculate the SPP score, the IUCN codes will be converted to numeric scores and then averaged within each region.

To calculate the ICO score, the species will be subset based on what is considered an iconic species and then the IUCN codes will be 
converted to numeric scores, and than averaged within each region.

##### 2.2.2 Benthic data

Weird thing: you can download a map for each species, but all the species are included in each file.  The
only difference is that there is a unique html downloaded from IUCN for the species in question.

These data are in the format of polygons that are functionally rasters.

The corresponding benthic dbf file is saved as csv: benthos_spatial_data.csv 

Painstakingly made a file to match the names in .shp file with the species names and vulnerability: benthic_species.csv

##### 2.2.3 Bird data 
There was no combined Helcom spatial file for birds (like there was for the benthic data).  

One complication was that some species had data in the format of the "raster-style" polygons.  While others were actual range polygons.

Given this, each bird spatial file was opened and then the range polygons were overlapped with the bhi regions.  

NOTE: one bird species fell out of the bhi polygon areas and was excluded. I would probably ignore....but it might be worth figuring out.

The spatial files downloaded from Helcom are located here: /var/data/ohi/git-annex/Baltic/spp/Birds

The script used to open each bird file and associate the polygons with BHI regions is: bird_data_extract.R

The extracted bird data is here: intermediate/birds.csv

##### 2.2.4 Mammal data
There is a combined file for mammals.  The ranges are described using polygons that relate to subbasins.

Some species have multiple IUCN categories (probably due to subspecies)
It would be ideal if we know which categories correspond to which regions, 
but these data are not available. 
two possible options are:
   1. average them
   2. use the most conservative option
I am going with #2 for now, but this would be easy to change (code in mammal_extract.R).
   
The script used to extract the data was: mammal_extract.R
The extracted mammal data are here: intermediate/mammals.R


##### 2.2.5 Fish data
There is a combined file for fish.  The range data are polygons that correspond to subbasins.


##### 2.2.6 Macrophyte data
N=17 datapoints fell outside the water.  This could probably be corrected by extracting the CELLCODES that land inland with some buffer.  
Don't know if this is worth the effort...

## 3. Goal status and trend
BD goal will only be based on the SPP sub-component

### 3.1 Goal status
Xspp_r = 1- sum[wi]/R;  wi = threat weights for each species i, R = total number of species in BHI region r  
Ref pt = R (eg. score equals 1 when all species i have wi of LC)  
Scale min value = score is 0 when 75% of species are extinct.*  
*From Halpern et al 2012, SI. "We scaled the lower end of the biodiversity goal to be
0 when 75% species are extinct, a level comparable to the five documented mass extinctions"  

wi from Halpern et al 2012, SI
EX = 1.0  
CR = 0.8  
EN = 0.6  
VU = 0.4  
NT = 0.2  
LC = 0
DD = not included, "We did not include the Data Deficient classification as assessed species following previously published guidelines for a mid-point approach"  

### 3.2 Goal trend


## 4. Data layer preparation

### 4.1 Data organization

#### 4.1.1 Read in species data
```{r read in species data}
## read in data...
data = read.csv(file.path(dir_spp, 'data/species_IUCN.csv'))
dim(data)
str(data)
```

#### 4.1.2 Set up vulnerability code
```{r vulnerability codes}

vuln_lookup = data %>%
              select(IUCN)%>%
              distinct(.) %>% ## unique vulnerability codes
              mutate(IUCN_numeric = ifelse(IUCN == 'EX',1,
                                    ifelse(IUCN == 'CR',0.8,
                                    ifelse(IUCN == 'EN', 0.6,
                                    ifelse(IUCN == 'VU', 0.4,
                                    ifelse(IUCN == 'NT', 0.2,
                                    ifelse(IUCN == 'LC',0,NA))))))) ## DD will receive NA
vuln_lookup ## note, no species with EX

```

#### 4.1.3 Join numeric vulnerability code to species
```{r join numeric vulnerability}

data2 = data %>%
        left_join(.,vuln_lookup, by= "IUCN")
head(data2)

```

#### 4.1.4 Plot by region
```{r plot raw by region}
ggplot(data2)+
  geom_point(aes(rgn_id, species_name),size=1)+
  facet_wrap(~IUCN)+
  theme(axis.text.y = element_text(colour="grey20", size=2, angle=0, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle ("Species presence and vulnerability by region")


ggplot(data2)+
  geom_point(aes(rgn_id, species_name, colour=taxa),size=1)+
  facet_wrap(~IUCN)+
  theme(axis.text.y = element_text(colour="grey20", size=2, angle=0, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle ("Species presence and vulnerability by region")

```

#### 4.1.5 Distribution in IUCN categories
Benthos & macrophytes have many more DD
```{r distribution in IUCN categories}
## how many in each category from each taxa group?
percent_vuln = data2 %>% 
  select(-rgn_id)%>%
  distinct()%>%
  select(IUCN,taxa) %>% 
  count(taxa,IUCN) %>%
  group_by(taxa)%>%
  mutate(n_tot = sum(n))%>%
  ungroup()%>%
  mutate(percent = round(n/n_tot,2)*100)%>%
  print(n=24)

ggplot(percent_vuln, aes(x=taxa, y=percent, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Percent of species in each IUCN category")

```

#### 4.1.6 Total number of species in each taxa group by IUCN categroy
```{r number of species in each taxa group}

ggplot(percent_vuln, aes(x=taxa, y=n, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Number of species in each IUCN category")



ggplot(filter(percent_vuln, IUCN != "DD"), aes(x=taxa, y=n, fill=IUCN))+
  geom_bar(stat="identity")+
  ggtitle("Number of species in each IUCN category without DD")


```


#### 4.1.7 Remove DD species
Species given DD are not included. See methods above and in Halpern et al. 2012  

Benthos has a much larger number of species in DD category
```{r remove DD}

data3 = data2 %>%
        filter(IUCN != "DD")
dim(data3);dim(data2)

```

#### 4.1.8 Check for duplicates
```{r check for duplicates}
data3 %>% nrow() #2205
data3 %>% distinct() %>% nrow() #2096

## appears to be duplicates

##remove duplicates by selecting the distinct columns
data3 = data3 %>% 
        arrange(rgn_id,species_name) %>%
        distinct()
        
dim(data3) #2096

```

#### 4.1.7 Export Species list 
Export species list to be check to see if sufficient coverage
```{r export species list}
species_list = data3 %>%
              select(species_name,taxa)%>%
              distinct(.)
dim(species_list) #125  1

write.csv(species_list, file.path(dir_spp,'species_list_included.csv'), row.names=FALSE)


```


### 4.2 Data layer for functions.r
```{r data layer for functions.r}
data3 = data3 %>%
        select(rgn_id, species_name, IUCN_numeric) %>%
        dplyr::rename(weights = IUCN_numeric)
##write.csv(data3, file.path(dir_layers, 'spp_div_vuln_bhi2015.csv'), row.names=FALSE)

```

### 4.3 Status calcalculation

#### 4.3.1 Calculate status
```{r status calculation}
##sum the weights for each BHI region
sum_wi = data3 %>%
         group_by(rgn_id)%>%
         summarise(sum_wi =sum(weights))%>%
         ungroup()
dim(sum_wi)

## count the number of species in each BHI region
sum_spp = data3 %>%
          select(rgn_id, species_name)%>%
          dplyr::count(rgn_id)
dim(sum_spp)


data3%>% filter(rgn_id== 1) %>% nrow() ## check to make sure works
head(sum_spp)

spp_status = full_join(sum_wi,sum_spp, by="rgn_id") %>%
             mutate(wi_spp = sum_wi/n,
                    status = 1 - wi_spp)
               

```

#### 4.3.2 Scale lower end to zero if 75% extinct
Currently, no species labeled extinct but will set up code in case used in the future

```{r scale for 75 percent extinct}
## calculate percent extinct in each region
spp_ex = data3 %>% 
         filter(weights == 1)
spp_ex
## No species extinct
## IF spp are extinct, find % extinct out of total number of species for each region; join to the status calculation; set regions with 75% or more extinct to a score of 0

```

#### 4.3.3 Plot status
```{r plot spp status}
## Plot status
ggplot(spp_status)+
  geom_point(aes(rgn_id,round(status*100)),size=3)+
  ylim(0,100)+
  ylab("Status") + 
  xlab("BHI region")+
  ggtitle("SPP status by BHI region")

## Size points to number of species in a region
ggplot(spp_status)+
  geom_point(aes(rgn_id,round(status*100), size=n))+
  ylim(0,100)+
  ylab("Status") + 
  xlab("BHI region")+
  ggtitle("SPP status by BHI region, n= species richness")

```

## TO DO
1. Check species that are included- are these only native species or both native and non-native? - for example have checked and Marenzelleria spp not included.  
2. Are the species included sufficient? What species are missing?  
3. How to calculate trend?
