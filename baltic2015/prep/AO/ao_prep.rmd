---
title: "ao_prep.rmd"
output: github_document
params: 
    datasource: csv
---
# AO Goal Data Prep

## Goal Overview

### Components
This goal has three sub-components: *stock, access, and need*. For BHI we focus first on the *stock* sub-component and will use this as a proxy for the entire goal initially

### Goal model
Xao = Mean Stock Indicator Value /  Reference pt  
Stock indicators = three HELCOM core indicators assessed for good environemental status (each scored between 0 and 1 by BHI)  
Reference pt = maximum possible good environmental status (value=1)  
*Should it be the mean of the 3 indicators or the sum of the three?*  

## Data
[HELCOM Core Indicator Abundance of coastal fish key functional groups](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-coastal-fish-key-functional-groups/)  

[HELCOM Core Indicator Abundance of key coastal fish species](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-key-coastal-fish-species)  

Good Environmental Status (GES) is assessed as either *GES* or *sub-GES* based on data times series using either a baseline or a trend approach, [see explanation](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-key-coastal-fish-species/good-environmental-status/). There is only a single assessment for each region.  

*status qualifying comments*: for one dataset if a monitoring station receives a "sub-GES" assessment, it is given a qualifier as "low" or "high".  

Environmental status assessments provided by Jens Olsson (SLU).  See [HELCOM FISH-PRO II](http://www.helcom.fi/helcom-at-work/projects/fish-pro/)  

### Data locations
Data are from monitoring locations (described in the HELCOM core indicators). Finnish data are fisheries data from ICES assessment regions (ICES 29-32).

## Data Prep

### Data scoring
We will have to determine appropriate 0-1 scale for *GES* and *sub-GES*

##

```{r setup, echo=FALSE}

## source common libraries, directories, functions, etc
source('~/github/bhi/baltic2015/prep/common.r')

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## rprojroot
root <- rprojroot::is_rstudio_project

## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))


dir_ao    = file.path(dir_prep,'AO')


## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_ao, 'ao_prep.rmd')
```


## Layer prep

```{r read in data}
## read in data...
  ## data are in "ao_data_database" - currently csv loaded directly there, need to put in the database and then set up script to extract

#assessment of GES status, all 2 indicators
coastal_fish = readr::read_csv2(file.path(dir_ao, 'ao_data_database/ao_coastalfish_ges_status.csv'))

head(coastal_fish)
dim(coastal_fish)
str(coastal_fish)

#locations of specific monitoring stations
coastal_fish_loc = read.csv(file.path(dir_ao, 'ao_data_database/ao_coastalfish_locations.csv'),
                          sep=";") ## can't use read_csv2 because while includes sep = ";" as the default, also has the default decimal separator as a comma so does not know what to do with a period

head(coastal_fish_loc)
dim(coastal_fish_loc)
str(coastal_fish_loc)        

## Station cleaned is a column that I created to make the station names match those under "monitoring_area" in the status asssessment

## assign lat-lon for ICES area to allow map plotting - assign location in center of Finnish coasts for ICES areas (29-32)

##ICES 31
 ##64.207281
 ##23.511161
##ICES 30
 ##61.679815
 ##21.269112
##ICES 29
 ##59.705518
 ##21.264879
##ICES 32
 ##60.108130
 ##25.772410
##Finnish Rectangle 23 & 28 (The Quark)
 ##63.505817
 ##21.351243

coastal_fish_loc = coastal_fish_loc%>%
                    mutate(lat = DECWGSN,
                           lon = DECWGSE)%>%
                    mutate(lat = ifelse(station_cleaned== "ICES SD 31", 64.207281,
                                 ifelse(station_cleaned== "ICES SD 30", 61.679815,
                                 ifelse(station_cleaned== "ICES SD 29", 59.705518,
                                 ifelse(station_cleaned== "ICES SD 32", 60.108130,
                                 ifelse(station_cleaned== "Rectangle 23 & 28",  63.505817,lat ))))),
                           lon = ifelse(station_cleaned== "ICES SD 31", 23.511161,
                                 ifelse(station_cleaned== "ICES SD 30", 21.269112,
                                 ifelse(station_cleaned== "ICES SD 29", 21.264879,
                                 ifelse(station_cleaned== "ICES SD 32", 25.772410,
                                 ifelse(station_cleaned== "Rectangle 23 & 28",  21.351243,lon ))))))%>%
                    mutate(station_cleaned = as.character(station_cleaned),
                           station = as.character(station))
str(coastal_fish_loc)

#bhi region and HOLAS basin look up
 basin_lookup = readr::read_csv(file.path(
  dir_prep,"baltic_rgns_to_bhi_rgns_lookup_holas.csv"))
basin_lookup=basin_lookup %>% select(bhi_id = rgn_id, basin_name)%>%
  mutate(basin_name = str_replace_all(basin_name,"_"," ")) 
basin_lookup

```


## Assign scores to GES status

```{r assign scores}
## is status ever NA?
coastal_fish %>% filter(is.na(status)) #No

## Assign three alternative 0-1 scores
  ## score 1:  GES =1, subGES = 0
  ## score 2:  GES =1, subGES = 0.2
  ## score 3:  GES =1, subGES (low)= 0.2, subGES (high)=0.5, subGES = 0.2

coastal_fish_scores = coastal_fish %>% 
                      mutate(score1 = ifelse(status== "GES",1,0),
                             score2 = ifelse(status=="GES",1,.2),
                             score3 = ifelse(status== "GES",1,
                                      ifelse(status=="subGES" & is.na(status_comment)==TRUE,.2,      
                                      ifelse(status=="subGES" & status_comment == "Low",.2,
                                      ifelse(status=="subGES" & status_comment == "High",.5,0)))))
                                     
                                     

coastal_fish_scores


```

## Plot alternative scores by location
Three separate plots for alternative scoring methods
```{r plot alt scores}

# make coastal_fish_scores in long format then plot
temp_long = coastal_fish_scores %>% 
            select(monitoring_area,core_indicator, score1,score2,score3) %>%
            group_by(monitoring_area, core_indicator) %>%
            gather(score_type,score,score1,score2,score3)%>%
            ungroup()

#Score 1
ggplot(filter(temp_long, score_type=="score1")) + 
  geom_point(aes(monitoring_area, score))+
  facet_wrap(~core_indicator)+
   theme(axis.text.x = element_text(colour="grey20",size=7,angle=90,hjust=.5,vjust=.5,face="plain"),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  ggtitle("Scoring Method 1")


#Score 2
ggplot(filter(temp_long, score_type=="score2")) + 
  geom_point(aes(monitoring_area, score))+
  facet_wrap(~core_indicator)+
   theme(axis.text.x = element_text(colour="grey20",size=7,angle=90,hjust=.5,vjust=.5,face="plain"),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  ggtitle("Scoring Method 2")


#Score 3
ggplot(filter(temp_long, score_type=="score3")) + 
  geom_point(aes(monitoring_area, score))+
  facet_wrap(~core_indicator)+
   theme(axis.text.x = element_text(colour="grey20",size=7,angle=90,hjust=.5,vjust=.5,face="plain"),
        plot.margin = unit(c(1,1,1,1), "cm")) +
  ggtitle("Scoring Method 3")



```


## Unique indicators per monitoring location
1. Is more than one key species monitored at a given locations?  
**NO**
2. Is more than one function group monitored?  
**Depends on location, 1 or 2 groups monitored**  
3. Are both key species and functional groups monitored at all locations?
**No** 4 monitoring areas without Functional status, 2 without Key_spp status  

```{r unique indicators monitoring region}

coastal_fish_scores_long = coastal_fish_scores %>% 
            group_by(Basin_HOLAS,Basin_assessment, country,monitoring_area,
                     period, coastal_water_type,core_indicator,taxa, assessment_method,
                     status,status_comment) %>%
            gather(score_type,score,score1,score2,score3)%>%
            ungroup()

coastal_fish_scores_long

## Number of indicators by monitoring location
indicator_count = coastal_fish_scores_long %>%
                  select(monitoring_area, core_indicator,taxa,score_type,score)%>%
                  group_by(monitoring_area)%>%
                  summarise(unique_indicator = length(unique(core_indicator)),
                            unique_taxa_func =  length(unique(taxa))) %>%
                ungroup()

indicator_count %>% print(n=60)

indicator_taxa_count= coastal_fish_scores_long %>% filter (score_type=="score1") %>% #remove duplicates based on scoring alternatives
                    select(monitoring_area, core_indicator,taxa)%>%
                  group_by(monitoring_area,core_indicator)%>%
                  summarise(unique_taxa_func =length(unique(taxa)))%>%
                  ungroup()
                  
indicator_taxa_count %>% print(n=60)

ggplot(indicator_taxa_count) + geom_point(aes(monitoring_area, unique_taxa_func))+
                              facet_wrap(~core_indicator)+
                              theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                                               hjust=.5, vjust=.5, face = "plain"),
                                    plot.margin = unit(c(1,1,1,1), "cm")) 

##Number of NAs by each indicator
indicator_taxa_count %>%  spread(core_indicator,unique_taxa_func)%>% 
                          dplyr::rename(Key_species = `Key species`)%>%
                          summarise(Func_na = sum(is.na(Functional)),                                                                               KeySpp_na = sum(is.na(Key_species)))


```



## BHI score
1. Get mean score for each indicator type in each monitoring region.  
2. Take mean score for each indicator at the HOLAS basin scale.  
3. Take mean of the two indicators for each basin.  
4. Apply basin score to each BHI region  

```{r status calculation}

## indicator mean by monitoring area
monitoring_indicator_mean = coastal_fish_scores_long %>% select(Basin_HOLAS, monitoring_area,
                                                                core_indicator,score_type,score)%>%
                            group_by(Basin_HOLAS, monitoring_area,core_indicator,score_type)%>%
                            summarise(mean_core_monitoring_score = mean(score, na.rm=TRUE))%>%
                            ungroup()
monitoring_indicator_mean


# indicator mean by HOLAS basin
basin_indicator_mean = monitoring_indicator_mean %>%
                        group_by(Basin_HOLAS,core_indicator, score_type)%>%
                        summarise(mean_core_basin_score = mean(mean_core_monitoring_score,na.rm=TRUE))%>%
                        ungroup()
basin_indicator_mean

#HOLAS basin score (mean across the two indicators)
basin_mean_score = basin_indicator_mean %>%
                    group_by(Basin_HOLAS)%>%
                    summarise(mean_basin_score = round(mean(mean_core_basin_score,na.rm=TRUE),1))%>%
                    ungroup()
  
basin_mean_score


## BHI score
    ## join basin lookup

  bhi_mean_score = basin_mean_score %>% full_join(.,basin_lookup, by=c("Basin_HOLAS" = "basin_name"))
  bhi_mean_score %>% print(n=45)

  
  
```

## Plot scores at each level of aggregations

### Plot monitoring area indicator mean scores
```{r plot scores levels of aggregation}

##plot monitoring area indicator mean scores
ggplot(monitoring_indicator_mean) + 
  geom_point(aes(monitoring_area, mean_core_monitoring_score, color=core_indicator))+
  facet_wrap(~score_type)+
  theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
         plot.margin = unit(c(1,1,1,1), "cm")) 


##plot on map

## Join monitoring_indicator_mean to lat-lon
monitoring_indicator_mean_loc= monitoring_indicator_mean %>% left_join(., select(coastal_fish_loc, station_cleaned, lat, lon), by=c("monitoring_area" = "station_cleaned"))
str(monitoring_indicator_mean_loc)

## get the map
library('ggmap')
map = get_map(location = c(8.5, 53, 32, 67.5))


#Plot Scoring Alternative 1
map_data1 = monitoring_indicator_mean_loc %>% select(monitoring_area, core_indicator,score_type,mean_core_monitoring_score,lat,lon ) %>% 
  filter(score_type == "score1")

#set up the plot
plot_map = ggmap(map) +
  geom_point(aes(x=lon, y=lat, colour=mean_core_monitoring_score), data=map_data1,size = 2)

#plot the map
plot_map + scale_color_gradientn(colours=rainbow(2)) +
  ggtitle('Coastal Fish Stock Status, Score Type 1') +
  theme(title = element_text(size = 12))


#Plot Scoring Alternative 2
map_data2 = monitoring_indicator_mean_loc %>% select(monitoring_area, core_indicator,score_type,mean_core_monitoring_score,lat,lon ) %>% 
  filter(score_type == "score2")

#set up the plot
plot_map = ggmap(map) +
  geom_point(aes(x=lon, y=lat, colour=mean_core_monitoring_score), data=map_data2,size = 2)

#plot the map
plot_map + scale_color_gradientn(colours=rainbow(2)) +
  ggtitle('Coastal Fish Stock Status, Score Type 2') +
  theme(title = element_text(size = 12))



#Plot Scoring Alternative 3
map_data3 = monitoring_indicator_mean_loc %>% select(monitoring_area, core_indicator,score_type,mean_core_monitoring_score,lat,lon ) %>% 
  filter(score_type == "score3")

#set up the plot
plot_map = ggmap(map) +
  geom_point(aes(x=lon, y=lat, colour=mean_core_monitoring_score), data=map_data3,size = 2)

#plot the map
plot_map + scale_color_gradientn(colours=rainbow(2)) +
  ggtitle('Coastal Fish Stock Status, Score Type 3') +
  theme(title = element_text(size = 12))


```

## Plot Basin scores


## Plot BHI Scores
```{r plot BHI scores}
#BHI Data
library(rgdal)
BHIshp = readOGR("C:/Users/jgrif/Documents/StockholmUnivPostDoc/BalticHealthIndex/BHI_r/March2016WkshpPlots/shapefiles", "BHI_regions_plus_buffer_25km")
BHIshp2 = spTransform(BHIshp, CRS("+proj=longlat +init=epsg:4326"))
print(proj4string(BHIshp2))

plot(BHIshp2)
```


## Next steps

1. Have Jens assess scoring options for GES status assessment.  

2. Have Jens assess method for scale up from monitoring location specific indicator status assessments to BHI region score.  

3. Check assignment of monitoring regions / assessment basins to HOLAS basins  
**Missing BHI scores** for Kiel Bay (should something be reassigned) and Gdansk Basin (no Polish data).  *Should we gap-fill with adjacent areas?*  
