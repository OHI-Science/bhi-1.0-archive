---
title: "ao_prep.rmd"
output: github_document
params: 
    datasource: csv
---
# AO Goal Data Prep

## Goal Overview

### Components
This goal has three sub-components: *stock, access, and need*. For BHI we focus first on the *stock* sub-component and will use this as a proxy for the entire goal initially

### Goal model
Xao = Mean Stock Indicator Value /  Reference pt  
Stock indicators = three HELCOM core indicators assessed for good environemental status (each scored between 0 and 1 by BHI)  
Reference pt = maximum possible good environmental status (value=1)  
*Should it be the mean of the 3 indicators or the sum of the three?*  

## Data
[HELCOM Core Indicator Abundance of coastal fish key functional groups](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-coastal-fish-key-functional-groups/)  

[HELCOM Core Indicator Abundance of key coastal fish species](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-key-coastal-fish-species)  

Good Environmental Status (GES) is assessed as either *GES* or *sub-GES* based on data times series using either a baseline or a trend approach, [see explanation](http://helcom.fi/baltic-sea-trends/indicators/abundance-of-key-coastal-fish-species/good-environmental-status/). There is only a single assessment for each region.  

*status qualifying comments*: for one dataset if a monitoring station receives a "sub-GES" assessment, it is given a qualifier as "low" or "high".  

Environmental status assessments provided by Jens Olsson (SLU).

## Data Prep

### Data scoring
We will have to determine appropriate 0-1 scale for *GES* and *sub-GES*

##

```{r setup, echo=FALSE}

## source common libraries, directories, functions, etc
source('~/github/bhi/baltic2015/prep/common.r')

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## rprojroot
root <- rprojroot::is_rstudio_project

## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))


dir_ao    = file.path(dir_prep,'AO')


## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_ao, 'ao_prep.rmd')
```


## Layer prep

```{r read in data}
## read in data...
  ## data are in "ao_data_database" - currently csv loaded directly there, need to put in the database and then set up script to extract

#assessment of GES status, all 2 indicators
coastal_fish = readr::read_csv2(file.path(dir_ao, 'ao_data_database/ao_coastalfish_ges_status.csv'))

head(coastal_fish)
dim(coastal_fish)
str(coastal_fish)

#locations of specific monitoring stations
coastal_fish_loc = readr::read_csv2(file.path(dir_ao, 'ao_data_database/ao_coastalfish_locations.csv')) #station location info - mix of lat-lon and a shape file value so not sure if needed
 
head(coastal_fish_loc)
dim(coastal_fish_loc)
str(coastal_fish_loc)                                  

#bhi region and HOLAS basin look up
 basin_lookup = readr::read_csv(file.path(
  dir_prep,"baltic_rgns_to_bhi_rgns_lookup_holas.csv"))
basin_lookup=basin_lookup %>% select(bhi_id = rgn_id, basin_name)%>%
  mutate(basin_name = str_replace_all(basin_name,"_"," ")) 
basin_lookup

```


## Assign scores to GES status

```{r assign scores}
## is status ever NA?
coastal_fish %>% filter(is.na(status)) #No

## Assign three alternative 0-1 scores
  ## score 1:  GES =1, subGES = 0
  ## score 2:  GES =1, subGES = 0.2
  ## score 3:  GES =1, subGES (low)= 0.2, subGES (high)=0.5, subGES = 0.2

coastal_fish_scores = coastal_fish %>% 
                      mutate(score1 = ifelse(status== "GES",1,0),
                             score2 = ifelse(status=="GES",1,.2),
                             score3 = ifelse(status== "GES",1,
                                      ifelse(status=="subGES" & status_comment == "low",.2,
                                      ifelse(status=="subGES" & status_comment == "high",.5,.2))))

coastal_fish_scores

```

## Plot alternative scores by location
```{r plot alt scores}
## TODO 
  ##Make coastal_fish_scores long data format, then plot



```


## Unique indicators per monitoring location
1. Is more than one key species monitored at a given locations?  
2. Is more than one function group monitored?  
3. How should these be combined more locally before taking a basin mean?
```{r unique indicators monitoring region}



```



## Average scores by within an indicator (key spp or functional) by HOLAS basin
This is probably not correct, probably need to combine within key species at a location first?
```{r average scores}
coastal_fish_indicator_mean = coastal_fish_scores %>%
                              group_by(Basin_HOLAS,core_indicator)%>%
                              summarise(mean_score1 = mean(score1),
                                        mean_score2 = mean(score2),
                                        mean_score3 = mean(score3))%>%
                              ungroup()


```

