---
title: "illegal_oil_prep"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---
# Prep of Illegal Oil Spill pressure data layer

```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')
library(stringr) # install.packages("stringr")
library(rgdal)  # install.packages('rgdal')
library(raster) # install.packages('raster')
library(rgeos)  # install.packages('rgeos')

source('~/github/bhi/baltic2015/prep/common.r')

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)



dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))



dir_oil    = file.path(dir_prep, 'pressures/illegal_oil_discharge')


## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_oil, 'illegal_oil_prep.rmd') 
```

## 1. Background


## 2. Data

### 2.1 Data source
Data were downloaded from [HELCOM's Baltic Sea Pressures and Human Activities Map Service](http://maps.helcom.fi/website/Pressures/index.html). Data were under the tab 'Maritime & Response' then 'Illegal Oil Discharges'

Data were downloaded on 17 March 2016.  

Data are available from 1998-2014. 

Data are listed with a location (lat, lon) and a Estimated spill volume. Sometimes spill area is also provided.  

## 3. Pressure model
Assign all spill locations a BHI ID. Sum the total volume of illegal oil spilled in each BHI region in each year.

Calculate the volume spilled per region surface area

Note- Exclude reported spills with volume  

Provide summary of total oil spills reported per year per BHI region, number reported with volumes per year per BHI region  

### 3.1 Current conditions

Mean volume spilled in each BHI region 2009-2014 / region surface area

### 3.2 Rescaling 0 to 1

min value =  0

max value =  max annual volume spilled / per surface area  *spatial reference*


## 4. Data Layer preparation

Steps:  
1. Get a BHI region assignment for all oil spill reports - do this by overlaying lat, lon locations with BHI shapefile  
2. Get volume spilled by year by BHI region (also visualize number of spills per year per BHI region, number of spills with zero volumne reported)  
3. Get current conditions, find max value, rescale data to between 0 and 1  
4. Export and register data layer
```{r TODO, echo=FALSE, message=FALSE}
## read in data...

## read in BHI shape file
bhi = rgdal::readOGR(dsn = path.expand(file.path(dir_shp, 'BHI_MCG_shapefile')),
                      layer = 'BHI_MCG_11052016')  

# bhi@proj4string
list.files(file.path(dir_shp, "Illegal_Oil_Discharges"))

## read in Illegal Oil Discharge file

oil = rgdal::readOGR(dsn = path.expand(file.path(dir_shp, 'Illegal_Oil_Discharges')),
                      layer = 'IllegalOilDischarges')  

oil_data = oil@data

write_csv(oil_data, file.path(dir_oil, "oil_data_raw.csv"))

## initial exploration: the same as bhi coord. system
# oil@proj4string
#  +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs 

# years covered: 
# unique(oil_data$Year)
# 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014

## plot data...
plot(oil); plot(bhi, border = "grey", main = "Illegal Oil Discharges and BHI regions overlay", add = TRUE); legend('bottom', c("BHI regions", " Illegal Oil Discharges"), lty = c(1,1), lwd = c(2.5, 2.5, 2.5), col = c("grey", "black"), text.font = 1, box.lty = 0 )

## intersect with BHI regions

oil_bhi_intersect = raster::intersect(oil, bhi)
# plot(oil_bhi_intersect)
# head(oil_bhi_intersect@data)
write_csv(oil_bhi_intersect@data, file.path(dir_oil, "ohi_bhi_intersect.csv"))



```
