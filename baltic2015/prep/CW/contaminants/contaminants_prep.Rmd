---
title: "contaminants_prep"
output: github_document
params: 
    datasource: csv
---
```{r setup}

## source common libraries, directories, functions, etc
# Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')

source('~/github/bhi/baltic2015/prep/common.r')
dir_cw    = file.path(dir_prep, 'CW')
dir_con    = file.path(dir_prep, 'CW/contaminants')

## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_con, 'contaminants_prep.rmd')

```

# Contaminant Data Prep

## 1 Indicators
3 indicators are proposed, describing different aspects of toxicity, and then would be combined to give an overall contamimant sub-component status.  

### 1.2 (1) PCB concentration indicator

#### 1.2.1 Original PCB indicator: ICES-6 PCB
Non-dioxin like PCBs: sum of congeners (28, 52, 101, 138, 153, 180) 75 μg/kg ww fish muscle  

This is similar to the ICES-7 except that PCB 118 is excluded (since it is metabolized by mammals).  

75 ng/g wet weight is the [EU threshold for fish muscle. See Section 5 Annex, 5.3](http://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=OJ:L:2011:320:0018:0023:EN:PDF). This threshold was also agreed upon as GES boundary at the most recent meeting of the [Working Group on the State of the Environment and Nature Conservation](http://helcom.fi/helcom-at-work/groups/state-and-conservation) April 11-15, 2016. *Recevied the draft report from Elisabeth Nyberg*  


#### 1.2.2 Alternatie PCB indicator: CB-153 Concentration
CB-153 concentration  
    - Suggested by Anders Bignet and Elisabeth Nyberg.
    - This would be a good indicator because it is abundant (so almost always measured) and will have few detection / quantification limit problems.  
    - They suggest using the EU threshold for human health as the reference point.  

EU documents seem to only focus on the ICES6 indicator.  However, OSPAR as individual CB thresholds.
[OSPAR background](http://qsr2010.ospar.org/media/assessments/p00390_supplements/p00461_Background_Doc_CEMP_Assessmt_Criteria_Haz_Subs.pdf).  

Table 1, p.14: Blue range = Status is acceptable. Concentrations are close to background or zero, i.e. the 
ultimate aim of the OSPAR Strategy for Hazardous Substances has been achieved.   

Table 5c. Blue < BAC  = CB153 0.2 μg/kg wet weight. *(this number differs in what is summarized for this report in the HELCOM core indicator document from 2013)*  

**Older documents with background**  
Additional information from HELCOM on the Core Indicators:  
[HELCOM Core Indicator of Hazardous Substances Polychlorinated biphenyls (PCB) and dioxins and furans 2013](http://www.helcom.fi/Core%20Indicators/HELCOM-CoreIndicator_Polychlorinated_biphenyls_and_dioxins_and_furans.pdf). *This document is now outdated*

*Determination of GES boundary*
The CORESET expert group decided that, due to uncertainties in the target setting on the OSPAR and EU working groups, the seven PCBs should be monitored and concentrations analysed but the core indicator assesses primarily two congeners only: CB-118 (dioxin like) and 153 (non-dioxin like). Tentatively the OSPAR EACs for these two congeners are suggested to be used.



### 1.3 (2) TEQ value for PCBs and Dioxins
Dioxin and dioxin-like compounds:0.0065 TEQ/kg ww fish, crustaceans or molluscs (source of target:EQS biota human health). Secondary GES boundary: CB-118 24 μg/kg lw fish liver or muscle (source: EAC).  

This threshold was also agreed upon as GES indicator at the most recent meeting of the [Working Group on the State of the Environment and Nature Conservation](http://helcom.fi/helcom-at-work/groups/state-and-conservation) April 11-15, 2016. *Recevied the draft report from Elisabeth Nyberg*  

**Older documents with background** 
[HELCOM Core Indicator of Hazardous Substances Polychlorinated biphenyls (PCB) and dioxins and furans](http://www.helcom.fi/Core%20Indicators/HELCOM-CoreIndicator_Polychlorinated_biphenyls_and_dioxins_and_furans.pdf)  *This document is now outdated*  

Dioxins are included in several international agreements, of which the Stockholm Convention and the Convention on Long Range Transboundary Air are among the most important for the control and reduction of sources to the environment. WHO and FAO have jointly established a maximum tolerable human intake level of dioxins via food, and within the EU there are limit values for dioxins in food and feed stuff (EC 2006). Several other EU legislations regulate dioxins, e.g. the plan for integrated pollution prevention and control (IPPC) and directives on waste incineration (EC, 2000, 2008). The EU has also adopted a Community Strategy for dioxins, furans and PCBs (EC 2001).

**Determination of GES boundary**
For dioxins, it was decided to use the GES boundary of 4.0 ng kg-1 ww WHO-TEQ for dioxins and 8.0 ng kg-1 ww WHO-TEQ for dioxins and dl-PCBs.

### 1.4 (3) PFOS indicator

[HElCOM PFOS core indicator document](http://www.helcom.fi/Core%20Indicators/PFOS_HELCOM%20core%20indicator%202016_web%20version.pdf)

### 1.5 Additional references
[Faxneld et al. 2014](http://www.diva-portal.org/smash/record.jsf?pid=diva2%3A728508&dswid=1554) Biological effects and environmental contaminants in herring and Baltic Sea top predators  


## 2. Data

### 2.1 Data sources

#### 2.1.1 PCB data
**ICES**
[ICES database](http://dome.ices.dk/views/ContaminantsBiota.aspx)  
Downloaded 22 April 2016 by Jennifer Griffiths
Data selections:
Year - 1990-2014
Purpose of monitoring = All
Country = ALL
Monitoring Program = ALL
Parameter Group = Chlorobiophenyls
Reporting Laboratory = All
Analytical laboratory = All
Geographical Areas = (HELCOM) ALL HELCOM Sub-basins

#### 2.1.2 Dioxins

#### 2..3 PFOS


#### Other sources
IVL (Svenska Miljönstitutet / Swedish Environmental Research Institute)  
[IVL database](http://dvsb.ivl.se/)  
Downloaded 2 December 2015 by Cornelia Ludwig  


### 2.2 Data prep prior to database
#### 2.2.1 PCB
Raw data from ICES were prepared in `~/github/bhi/baltic2015/prep/CW/contaminants/raw_contaminants_data_prep`
    - If duplicate measurements were made from the same sample, values were averaged (all were two measurement of LIPIDWT% per sample, all from 2014, Poland). 
    -  Data were standardized to the same unit ug/kg  
    - If data were presented in lipid weight, they were converted to wet weight by: (EXLIP% / 100)*(CB-conc lipid weight).   


## 3. Other Info 
........

## 4. Data Prep - PCB Indicator

### 4.1 Basic data cleaning and organization

#### 4.1.1 Read in PCB data
```{r read in data, echo=FALSE, message=FALSE}
## read in PCB data
pcb1 = read.csv(file.path(dir_con, 'contaminants_data_database/ices_herring_pcb.csv'))
dim(pcb1)


## Read in lookup - BHI region to HOLAS basins
lookup_basins = read.csv(file.path(dir_con,'baltic_rgns_to_bhi_rgns_lookup_holas.csv'))



```

#### 4.1.2 Organize
Remove and rename columns, change column data types
```{r organize data}
str(pcb1)

#format date as date
pcb2 = pcb1 %>% 
      dplyr::rename(date=Date, lat=Latitude, lon= Longitude, 
                    month=Month, day=Day, doy=DoY,
                    bhi_id = BHI_ID, helcom_id=HELCOM_ID, 
                    helcom_coastal_code=HELCOM_COASTAL_CODE, ices_area = ICES_AREA,
                    agmax_y = AGMAX_y, agmea_y=AGMEA_y, agmin_y = AGMIN_y,
                    drywt_percent = DRYWT._., exlip_percent = EXLIP._.,fatwt_percent=FATWT._.,
                    lipidwt_percent = LIPIDWT._., lnmax_cm = LNMAX_cm,
                    lnmea_cm=LNMEA_cm, lnmin_cm=LNMIN_cm, wtmax_g=WTMAX_g, wtmea_g=WTMEA_g,
                    wtmin_g=WTMIN_g) %>% # rename columns
      select(-date_ices, -X) %>% #remove columns not needed
      mutate(date =as.Date(date,"%Y-%m-%d"),
             sub_samp_id= as.character(sub_samp_id)) %>%
      select(country:lon,bhi_id:ices_area,date:year,month:doy,species:value)## reorder columns

head(pcb2)

```

#### 4.1.3 Plot data
Explore raw data.
**Why are there unassigned BHI regions?**
```{r plot data}

ggplot(pcb2) + geom_point(aes(date,value, colour=congener)) +
  facet_wrap(~bhi_id)

```

#### 4.1.4 Filter for ICES 6 PCBs
```{r filter ices 6}
ices6pcb = c("CB28_ug/kg", "CB52_ug/kg", "CB101_ug/kg", "CB138_ug/kg",
            "CB153_ug/kg", "CB180_ug/kg")
  
pcb3 = pcb2 %>% 
        filter(congener %in% ices6pcb)

dim(pcb3); dim(pcb2)

```

#### 4.1.5 Plot data -ICES 6 pcbs
```{r plot ices 6}
ggplot(pcb3) + geom_point(aes(date,value, colour=congener)) +
  facet_wrap(~bhi_id)
```

#### 4.1.6 Stations with No BHI ID
Why were some data not assigned a BHI ID (through script in BHI database).  
Will check with Marc, might be because very near coast and BHI regions don't extend?
```{r  bhiid na}

## which stations have no BHI ID assigned
pcb3 %>% filter(is.na(bhi_id)) %>% select(country,station, lat, lon) %>% distinct(.)

##country            station     lat     lon
##1  Sweden     Gaviksfjaerden 62.8645 18.2412
##2  Sweden Kinnbaecksfjaerden 65.0568 21.4750
##3  Sweden  Langvindsfjaerden 61.4554 17.1622

```

#### 4.1.7 Manually assign BHI to stations missing
```{r assign missing bhi regions}

##Gaviksfjaerden is BHI region 37
##Kinnbaecksfjaerden is BHI region 41
##Langvindsfjaerden is BHI region 37

pcb4 = pcb3 %>%
      mutate(bhi_id = ifelse(station=="Gaviksfjaerden",37,
                      ifelse(station=="Kinnbaecksfjaerden", 41,
                      ifelse(station=="Langvindsfjaerden",37,bhi_id))))
pcb4 %>% filter(is.na(bhi_id)) %>% select(country,station, lat, lon) %>% distinct(.)

##plot again
ggplot(pcb4) + geom_point(aes(date,value, colour=congener)) +
  facet_wrap(~bhi_id)


```


#### 4.1.8 Join to HOLAS basins and evaluate data coverage

```{r join to HOLAS basins}
pcb5 = full_join(select(lookup_basins, rgn_id, basin_name), pcb4, by= c("rgn_id"="bhi_id"))
head(pcb5)




```


#### 4.1.9 Plot by basin
```{r plot by basin}

ggplot(pcb5) + geom_point(aes(date,value, colour=congener)) +
  facet_wrap(~basin_name)

```

### 4.2 Evaluate sites sampled
What are the site representing: baseline/reference conditions or local impact.  

#### 4.2.1 Join PCB sites, station dictionary, and impact codes
```{r join sites with site info }
pcb_sites = pcb5 %>% 
            select(country, station,basin_name,lat,lon,rgn_id) %>%
            filter(!is.na(station)) %>%
            distinct(.)
pcb_sites


## join with station dictionary
pcb_sites = pcb_sites %>%
            left_join(., station_dictionary, 
                      by = c("country"="Country", "station" = "Station_name",
                             "lat" = "Latitude", "lon"="Longitude"))


```


### 4.3 Data flagged for quality
#### 4.3.1Evaluate data with Qflags
TO DO:
    - data if only use CB153 with and without qflags
    - data where all 6 congeners sampled with and without qflags
