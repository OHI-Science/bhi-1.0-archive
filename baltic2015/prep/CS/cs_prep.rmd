---
title: "cs_prep"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---

# Carbon Storage (CS) Data prep

## 1. Background on Zostera data

### 1.1 Why Zostera data

### 1.2 Zostera species in the Baltic Sea

### 1.3 Related publications
[Boström et al 2014](http://onlinelibrary.wiley.com/doi/10.1002/aqc.2424/abstract)  

[HELCOM Red List Biotope Information Sheet](http://helcom.fi/Red%20List%20of%20biotopes%20habitats%20and%20biotope%20complexe/HELCOM%20Red%20List%20AA.H1B7,%20AA.I1B7,%20AA.J1B7,%20AA.M1B7.pdf)  


## 2. Data source  
### 1.1 Download information 
[HELCOM Marine Spatial Planning Map Service](http://maps.helcom.fi/website/msp/index.html)  
Select -  Marine Spatial Planning - Ecology - Ecosystem Health status  
Data layer - "Zostera Meadows"  
Downloaded on 10 May 2016 by Jennifer Griffiths

[Metadata link](http://maps.helcom.fi/website/getMetadata/htm/All/Zostera%20meadows.htm)  

### 2.2 Additional background
*Notes from Joni Kaitaranta (HELCOM)*: According to the Zostera meadows metadata there is many data sources. The dataset was compiled in 2009-2010 for the HOLAS I assessment so the dataset is not very recent. Major source was Boström et al. 2003. In: Spalding et al. World Atlas of Seagrasses but there was also national e.g. from NERI Denmark downloaded in 2009 from a URL that is no longer valid.  

*Data Structure*: Is unclear, spatial files need to be reviewed. Is it just points, or does it include areal coverage of Zostera. Data observations are accompanies by either "dense" or "sparse." 

## 3. CS goal model overview
### 3.1 Status
X_cs_region = Current_area_Zostera_meadows_region / Reference_pt_region  

Reference_pt_region = Current_area_Zostera_meadows * 1.25  
This is based upon ["During the last 50 years the distribution of the Zostera marina biotope has declined >25%. The biotope has declined to varying extents in the different Baltic Sea regions."](http://helcom.fi/Red%20List%20of%20biotopes%20habitats%20and%20biotope%20complexe/HELCOM%20Red%20List%20AA.H1B7,%20AA.I1B7,%20AA.J1B7,%20AA.M1B7.pdf)  

**If data are not areal coverage**: if data are simply points of presence, need to rethink goal model


### 3.2 Trend
Use the trend of NUT subcomponent for CW goal (e.g. secchi status trend).  

Read the file in from 'layers' and resave as the CS trend for layers.  



## 4. Layer prep

```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')
library(stringr) # install.packages("stringr")

# source
source('~/github/bhi/baltic2015/prep/common.r') #for create_readme() function

## rprojroot
root <- rprojroot::is_rstudio_project

## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)


dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')



dir_cs   = file.path(dir_prep, 'CS')

## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_cs, 'cs_prep.rmd') 
```


### 4.1 Read in data
```{r read in data}

## directory setup

dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
           'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
           'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

if (Sys.info()[['sysname']] != 'Linux' & !file.exists(dir_M)){
  warning(sprintf("The Mazu directory dir_M set in src/R/common.R does not exist. Do you need to mount Mazu: %s?", dir_M))
  # TODO: @jennifergriffiths reset dir_M to be where the SRC hold your shapefiles
}

dir_shp <- file.path(dir_M, 'git-annex/Baltic')

cs_data <- rgdal::readOGR(dsn = path.expand(file.path(dir_shp, 'Bostera_meadows')),
                          layer = 'Zostera meadows')  


```

### 4.2 Explore and plot data
```{r explore data}
# explore data
plot(cs_data, col = cs_data@data$coverage )

head(cs_data@data) 

list(cs_data@data$name)
cs_data@proj4string
#  +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs 

## plot data...
bhi_transform = spTransform(bhi, cs_data@proj4string) # transform bhi to the same coordinate system; bhi from lsp_prep. need to expand here. 

plot(bhi_transform, col = 'light blue', border = "grey", main = "BHI regions and Meadows intersect"); plot(cs_data, col = 'blue', add = TRUE) 

# system.time({cs_bhi_intersect <- raster::intersect(cs_data, bhi_transform)})


```

### 4.3  Intersect the BHI shapefiles and zostera data

```{r intersect and save csv}
cs_bhi_intersect = sp::over(cs_data, bhi_transform)
head(cs_bhi_intersect)
plot(cs_bhi_intersect)

cs_bhi_data = cbind(cs_bhi_intersect, cs_data@data) %>%
  dplyr::select(country = rgn_nam, BHI_ID, Area_km2, coverage) %>%
  filter(!is.na(country))
  
# save data as csv
# write_csv(cs_bhi_data, file.path(dir_cs, 'cs_bhi_data.csv'))
```

