---
title: "tr_prep.rmd"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---

# Prepare Data Layers for Tourism and Recreation (TR) Goal 

## 1. Background 

## 2. Data 

### 2.1 Regional Accommodation Stays Data 

Eurostat dataset on Nights spent at tourist accommodation establishments by all NUTS regions with the finest scale spatial resolution at NUTS2. [tour_occ_nin2](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2&lang=en)  

Download Date: 10 Feb 2016, Download By: Jennifer Griffiths  

[Metadata](http://ec.europa.eu/eurostat/cache/metadata/en/tour_occ_esms.htm)

Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2)  

Selected all accommodation categories combined:Hotels; holiday and other short-stay 
accommodation; camping grounds, recreational vehicle parks and trailer parks  


Select all years available: 1990-2014  

Missing data indicated by colon (:)  

### 2.1 Regional Accommodation Stays Coastal/Non-Coastal Data 

Eurostat dataset on Nights spent at tourist accommodation establishments by coastal and non-coastal area from 2012 onwards.  These were download for all avaialable region levels. [tour_occ_nin2c](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2c&lang=en)  
Download Date: 10 Feb 2016, Download By: Jennifer Griffiths  

[Metadata](http://ec.europa.eu/eurostat/cache/metadata/en/tour_occ_esms.htm)  

Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2)  

Selected all accommodation categories combined:Hotels; holiday and other short-stay accommodation; camping grounds, recreational vehicle parks and trailer parks  

Selected Total, and split between Coastal & non-coastal regions  

Selected years available: 2012-2014  

Missing data indicated by colon (:)  

 

## 3. Goal Model 

### 3.1 Status Calculation

Xtr = a_r / a_ref_r  
a_r =  number of nights spent in coastal accommodations in BHI region r  
a_ref_r = a_r - 5  

r = BHI region  
a_r = (proportion population in 25km buffer in nuts2 association with r) x a_c  
n = NUTS2 region  
a_c = coastal accommodation stays in NUTS2 region n  
a_c = a_n x c_n1  
a_n = accomodation stays in NUTS2 region_n  
c_n1 = mean proportion of accommodations stays that are coastal at the NUTS1 level  

### 3.2 Trend calculation
Linear regression fit to the most recent 5 status years.  


## 4. Data Layer Preparation 

```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

source('~/github/bhi/baltic2015/prep/common.r')


## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)



dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))


dir_tr    = file.path(dir_prep, 'TR')



## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_tr, 'tr_prep.rmd') 
```

### 4.1 Data clean and organize 

#### 4.1.1 Read in data 
```{r read in the data}
## read in data...
## accomodation stays time series by NUTS region
accom = read.csv(file.path(dir_tr, "tr_data_database/accom.csv"),stringsAsFactors = FALSE)
dim(accom)

## accomodation stays for 2012-2014 by NUTS region divided by the coastal and non-coastal fractions
accom_coast = read.csv(file.path(dir_tr, "tr_data_database/accom_coast.csv"),stringsAsFactors = FALSE)
dim(accom_coast)

## NUTS2 population and area by BHI region fraction
nuts2_pop_area = read.csv(file.path(dir_tr, "tr_data_database/nuts2_pop_area.csv"), stringsAsFactors = FALSE)
dim(nuts2_pop_area)

## european country names and abbreviations
eu_names = read.csv(file.path(dir_prep,"EUcountrynames.csv"),sep=";", stringsAsFactors =FALSE)


```

#### 4.1.2 Clean Data 

##### 4.1.2.1 Acommodation stays time series 
```{r clean data Acommodation stays time series}

## Acommodation stays time series
str(accom)
## need to remove the BHI_ID columns - these are from an old join to the BHI shapefile, not relevant now.
## need to rename columns
## these data contain all NUTS levels from level 2 up, need to have them be just NUTS2 -- will do this when join to NUTS2 population data, will then have only the NUTS2 from the shapefile. 
## value has : for NA, fix
accom1 = accom %>%
         select(-contains("BHI"), - TIME_LABEL,-UNIT,-INDIC_TO, -NACE_R2 ) %>% ## remove BHI related columns, and other columns that are not needed
         dplyr::rename(year = TIME,
                       nuts = GEO, 
                       nuts_name = GEO_LABEL,
                       dat_descrip = INDIC_TO_LABEL,
                       unit = UNIT_LABEL,
                       dat_descrip2 = NACE_R2_LABEL,
                       value = Value,
                       flag_notes = Flag.and.Footnotes)%>%
          mutate(value = ifelse(value == ":", NA, value))%>%
          mutate(value = as.numeric(value))%>%
  mutate(dat_descrip = "Nights spent total",
                      dat_descrip2 = "Hotels and holiday and other short-stay accommodation and camping grounds recreational vehicle parks and trailer parks" )## fix so no commas or semi-colons

str(accom1)

## check flags
accom1 %>% select(flag_notes) %>% distinct()
accom1 %>% filter(flag_notes %in% c("c","e","u","be","b"))%>% select(year, nuts,value, flag_notes) #very few apply to Baltic countries, u is biggest concern = "low reliability"
accom1 %>% filter(flag_notes %in% c("u","bu"))%>% select(year, nuts,value, flag_notes) ##not baltic countries

accom1 = accom1 %>%
        select(-flag_notes)



```

##### 4.1.2.2  Coastal / non-coastal data 
Clean to get NUTS1 - higher resolution available for some areas (parts of Finland, German, Poland) but is not consistent.  However, NUTS1 does differ among countries. In Denmark, Estonia, Latvia, and Lithuania: NUTS1 is the entire country. *Note for Denmark this means non-Baltic coast is included*  
In Finland, Aland is one region and the rest of the country is another.  
In Sweden there are 3 regions in the entire country, and 1 region includes non-Baltic coast, all have substantial inland area.  
Germany and Poland each have 2 regions that are NUTS1 that border the Baltic.  

![See NUTS1 locations here](nuts1_regions_eurostat_image.png?raw=true)
```{r clean data  Coastal  non-coastal data}

## Coastal / non-coastal data
## need to remove the BHI_ID columns - these are from an old join to the BHI shapefile, not relevant now.
## need to rename columns
## these data are at multiple spatial resolutions, need to figure out finest scale resolution, export and do manually.  Differs by country. Also differs within Germany
str(accom_coast)
accom_coast1 = accom_coast %>%
         select(-contains("BHI"),-TERRTYPO, - TIME_LABEL,-UNIT,-INDIC_TO, -NACE_R2 ) %>% ## remove BHI related columns, and other columns that are not needed
         dplyr::rename(year = TIME,
                       nuts = GEO, 
                       nuts_name = GEO_LABEL,
                       location = TERRTYPO_LABEL,
                       dat_descrip = INDIC_TO_LABEL,
                       unit = UNIT_LABEL,
                       dat_descrip2 = NACE_R2_LABEL,
                       value = Value,
                       flag_notes = Flag.and.Footnotes)%>%
          mutate(value = ifelse(value == ":", NA, value))%>%
          mutate(value = as.numeric(value))

str(accom_coast1)

accom_coast %>% select(TERRTYPO, TERRTYPO_LABEL)%>% distinct()

## figure out which are the NUTS1 abbreviations from the other NUTS level abbreviations, select only NUTS1
accom_coast2 = accom_coast1 %>%
               mutate(country_abb = substr(nuts,1,2))%>% ## set up country abbreviation
               left_join(., eu_names, by="country_abb")%>% ## join to eu country names
               filter(grepl("Denmark|Estonia|Finland|Germany|Latvia|Lithuania|Poland|Sweden", country))%>% ## select only Baltic countries to make it easier
               mutate(dat_descrip = "Nights spent total",
                      dat_descrip2 = "Hotels and holiday and other short-stay accommodation and camping grounds recreational vehicle parks and trailer parks" ) %>% ## fix so no commas or semi-colons
                mutate(nuts0 = substr(nuts,1,2),
                       nuts1 = substr(nuts,1,3),
                       nuts1 = ifelse(nuts0==nuts1,NA,nuts1),
                       nuts_select = ifelse(nuts1==nuts,1,0)) %>% ## select data that are NUTS1
                filter(nuts_select ==1 ) %>% 
                select(-nuts_select,-nuts,-nuts0,-nuts_name) 
               
  
                     
## check flags
accom_coast2 %>% select(flag_notes)%>%distinct() ## b
accom_coast2 %>% filter(flag_notes =="b") ## just for 2012 for LV and LT

accom_coast2 = accom_coast2 %>%
               select(-flag_notes) %>%
               select(country,country_abb,nuts1,year,location,value,unit,dat_descrip,dat_descrip2)

head(accom_coast2)


```

##### 4.1.2.3 NUTS2 population data 
```{r clean data}
## nuts2 population data
str(nuts2_pop_area)

nuts2_pop_area1 = nuts2_pop_area %>%
                  select(-PopUrb,-PopRur,-PopUrb_density_in_buffer_per_km2,-PopRur_density_in_buffer_per_km2, -HELCOM_ID) %>%
                  dplyr::rename(rgn_id = BHI_ID,
                                nuts2 = NUTS_ID,
                                pop = PopTot,
                                pop_km2 = PopTot_density_in_buffer_per_km2,
                                country_abb= CNTR_CODE,
                                country = rgn_nam,
                                basin = Subbasin,
                                area = NUTS3_area_in_BHI_buffer_km2) ## this last column has NUTS3 in name, but is for NUTS2 data

str(nuts2_pop_area1)

```

#### 4.1.3 Check NUTS2 names from Finland 
Shapefiles have names from 2006, check accom1 and accom_coast1 to see if the names have been updated, will need to fix. 
![Map of old NUTS2 names for GUlf of Finland](BHI_regions_NUTS2_plot.png?raw=true)  
![Map of new NUTS2 names for GUlf of Finland](new_FI_nuts2.png?raw=true)  
```{r check fi nuts2 names}

accom1 %>% filter(grepl("FI",nuts))%>% select(nuts, nuts_name)%>% distinct()
## These are the newer region names : FI1B, FI1C, FI1D

accom_coast1 %>% filter(grepl("FI",nuts))%>% select(nuts, nuts_name)%>% distinct()
## These are the newer region names : FI1B, FI1C, FI1D

nuts2_pop_area1 %>% filter(grepl("FI",nuts2))%>% select(nuts2)%>% distinct()
## These are the older region names: FI18, FI1A

## Challenge because of coasts
## FI1C is associated with both the Gulf of Finland and the Aland Sea. FI1B has a small fraction associated with Aland Sea, the rest is Gulf of Finland

## Old FI18, contains both FI1C and FI1B.  May need to combine data from the new regions, and apply fraction from the older region.  Helsinki is in FI1B, which would assign almost entirely to BHI 32 and whereas FI1C would divide more equally btween BHI 36 and BHI 32. Therefore, combining these regions in order to apply the division generated from the old region may have a different result.

## old FI1A seems to be the same along the coast as the new FI1D but new FI1D covers inland areas previously in FI13

## Do this after joining accom and accom_coast with the nuts2_pop_area data, will have to add these regions back in.


```

#### 4.1.4 Check for incorrectly assigned NUTS2 regions to BHI regions and fix 
Note - (as in NUTS3 assignment issues see ECO), BHI region 21 not assigned to any NUTS2 regions - despite clear association with PL63. PL63 split only between BHI 17 and BHI 18
```{r check for incorrectly assigned NUTS2 regions}
## write to csv, fix manually, re-import csv
misassigned_nuts2 = nuts2_pop_area1 %>% select(nuts2,country,rgn_id)

#write.csv(misassigned_nuts2 , file.path(dir_tr, "misassigned_nuts2.csv"), row.names=FALSE)

## read in corrected assignments

corrected_nuts2 = read.csv(file.path(dir_tr,"misassigned_nuts2_manually_corrected.csv"),sep=";",stringsAsFactors = FALSE)


## join nuts2_pop_area1 with corrected data and fix

nuts2_pop_area2 = nuts2_pop_area1 %>%
                  full_join(., corrected_nuts2,
                            by=c("rgn_id","nuts2","country"))%>%
                 select(-country,-rgn_id,-incorrect,-BHI_ID_manual, -X.country_manual)%>%
                 dplyr::rename(country =X.correct_country,
                               rgn_id = X.correct_BH_ID)%>%
                  select(rgn_id,nuts2,country,country_abb,basin,pop,pop_km2,area) %>%
                  group_by(rgn_id, nuts2, country,country_abb,basin)%>%
                  summarise(pop =sum(pop),
                            pop_km2 = sum(pop_km2),
                            area = sum(area)) %>% ## some regions occurr twice because of correcting the assignment, sum to get single value for each region
                  ungroup()


str(nuts2_pop_area2)
```



### 4.2 Join datasets 

#### 4.2.1 Join accom times series with nuts pop and area 
Join data with inner join, this will exclude Finland areas with name mismatches. Fix Finnish data and add back into the dataset
```{r join accom1 with nuts_pop_area1}
accom_nuts1 = inner_join(accom1, nuts2_pop_area2,
                         by=c("nuts"="nuts2"))%>%
              dplyr::rename(nuts2 = nuts)

dim(accom1)##11250     8
dim(nuts2_pop_area2) ## 60 8
dim(accom_nuts1) ##1400  14

str(accom_nuts1) ## this is now missing the Finnish data where there are name discrepancies


## Get Finnish data renamed so that accommodating and population data match
fi_accom_newnuts = accom1 %>%
                   filter(nuts %in% c("FI1C","FI1B", "FI1D"))
fi_accom_newnuts

fi_nuts_oldnuts = nuts2_pop_area2 %>%
                  filter(nuts2 %in% c("FI18","FI1A"))

fi_nuts_oldnuts

## assign old nuts names to accom data
fi_accom_newnuts1 = fi_accom_newnuts %>%
                    mutate(nuts_old = ifelse(nuts == "FI1C","FI18",
                                      ifelse(nuts == "FI1B", "FI18",
                                      ifelse(nuts == "FI1D", "FI1A",""))),
                           nuts_name_old= ifelse(nuts == "FI1C" | nuts == "FI1B","old region",nuts_name ))%>%
                    select(-nuts, -nuts_name)%>%
                    dplyr::rename(nuts=nuts_old,
                                  nuts_name = nuts_name_old)%>%
                    group_by(year,nuts,nuts_name,dat_descrip,unit,dat_descrip2)%>%
                    summarise(value = sum(value))%>% ## combine all data from contributing sources into old FI unit
                    ungroup()
                        
head(fi_accom_newnuts1) ## there are NA but were NA for all regions in those years

## join fi accom to fi pop and area

fi_accom_correct_nuts = full_join(fi_accom_newnuts1, fi_nuts_oldnuts,
                          by=c("nuts"="nuts2"))%>%
                          dplyr::rename(nuts2=nuts)%>%
                          select(year,nuts2,nuts_name,dat_descrip,unit,dat_descrip2,
                                 value,rgn_id,country,country_abb,basin, pop,
                                 pop_km2,area)



### bind to rest of data
colnames(fi_accom_correct_nuts)
colnames(accom_nuts1)


accom_nuts2 = bind_rows(accom_nuts1, fi_accom_correct_nuts)
```

#### 4.2.2 Plot and check joined accom times series with nuts pop and area 

```{r plot accom_nuts2 joined data}
ggplot(accom_nuts2)+
  geom_point(aes(year,value, colour=nuts2))+
  geom_line(aes(year,value, colour=nuts2))+
  facet_wrap(~country, scale="free_y")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Time series accommodation stays NUTS2")


```

#### 4.2.3 Check to see if BHI regions are missing 
```{r are bhi regions missing from accom and pop join}
accom_nuts2 %>% select(rgn_id)%>%distinct()%>%arrange(rgn_id)

## there are 37 regions

##missing: 19,21, 22,30,33

## expected missing - 19,22, and 33 from Russia
## 21 from Poland because not assigned
## 30 has no coastline

```


#### 4.2.4 Join accom_coast data with nuts pop and area 
Using Level 1, this means the Finnish mismatches are not relevant here

```{r join accom_coast2 with nuts pop and area}

## Join to nuts area and population data
## first create nuts1 level for nuts pop and ear
nuts2_pop_area3 = nuts2_pop_area2 %>%
                  mutate(nuts1 = substr(nuts2,1,3),
                  nutslevel_pop = nuts2)%>%
                  select(-nuts2)
                    



## Join
accom_coast_nuts = accom_coast2 %>%
                          inner_join(., nuts2_pop_area3,
                                     by =c("country","country_abb","nuts1"))
          




## are there BHI regions missing?
accom_coast_nuts %>% select(rgn_id)%>% distinct() %>% arrange(rgn_id)

## 37 regions

##missing are:

## Russia 19, 22,33

## Poland no data assigned 21

## No coastal area 30


```



#### 4.2.5 Plot coastal and noncoastal stays at NUTS1 level 
```{r plot coastal noncoastal stays nuts1}
ggplot(accom_coast_nuts)+
  geom_point(aes(year,value, shape=location,colour=nuts1))+
  scale_shape_manual(values=c(0,17,8))+
  facet_wrap(~country)+
  ylab("Total Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Accommodation Stays by Location Type at NUTS1 level")
  



```

#### 4.2.6 Plot separate countries coastal and noncoastal stays at NUTS1 level 
For countries with more than 1 NUTS1 region
```{r plot coastal noncoastal stays nuts1 countries separate}
## Finland
ggplot(filter(accom_coast_nuts, country=="Finland"))+
  geom_point(aes(year,value, shape=location,colour=nuts1))+
  scale_shape_manual(values=c(0,17,8))+
  facet_wrap(~nuts1)+
  ylab("Total Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("FI Accommodation Stays by Location Type at NUTS1 level")



## Sweden
ggplot(filter(accom_coast_nuts, country=="Sweden"))+
  geom_point(aes(year,value, shape=location,colour=nuts1))+
  scale_shape_manual(values=c(0,17,8))+
  facet_wrap(~nuts1)+
  ylab("Total Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("SE Accommodation Stays by Location Type at NUTS1 level")


## Poland
ggplot(filter(accom_coast_nuts, country=="Poland"))+
  geom_point(aes(year,value, shape=location,colour=nuts1))+
  scale_shape_manual(values=c(0,17,8))+
  facet_wrap(~nuts1)+
  ylab("Total Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("PL Accommodation Stays by Location Type at NUTS1 level")

##Germany
ggplot(filter(accom_coast_nuts, country=="Germany"))+
  geom_point(aes(year,value, shape=location,colour=nuts1))+
  scale_shape_manual(values=c(0,17,8))+
  facet_wrap(~nuts1)+
  ylab("Total Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("DE Accommodation Stays by Location Type at NUTS1 level")



```

### 4.3 Proportion coastal stays at the NUTS1 level 

#### 4.3.1 Calculate Proportion coastal 
```{r calculate Proportion coastal stays nuts1}
accom_coast_nuts1 = accom_coast_nuts %>%
                    select(-dat_descrip,-dat_descrip2,-unit)%>%
                    mutate(location = ifelse(location == "Total","total",
                                      ifelse(location == "Coastal area","coastal","noncoastal")))%>%
                    spread(location,value)%>%
                    mutate(prop_coastal = coastal/total)%>%
                    select(-coastal,-total,-noncoastal, -pop,-pop_km2,-area)%>%
                    mutate(year = as.numeric(year))
  
```

####4.3.2 Plot proportion coastal NUTS1 accommodation stays
Very consistent across the three years
```{r plot nuts1 proportion coastal }
ggplot(accom_coast_nuts1)+
  geom_point(aes(year,prop_coastal,colour=nuts1))+
  facet_wrap(~country)+
  ylim(0,1)+
  ylab("Proportion Total Nights Coastal")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Proportion Coastal Accommodation Stays at NUTS1 level")
  
```

####4.3.3 Mean proportion coastal for each NUTS1 over the three years 

```{r mean proportion coastal}

accom_coast_nuts2 = accom_coast_nuts1 %>%
                    select(-year,-nutslevel_pop)%>%
                    group_by(country,country_abb,nuts1,rgn_id,
                             basin)%>%
                    summarise(mean_prop_coastal = mean(prop_coastal, na.rm=TRUE))
```

#### 4.3.4 Plot Mean proportion coastal accommodation stays for each NUTS1 

```{r  Plot Mean proportion coastal for each NUTS1 }
ggplot(accom_coast_nuts2)+
  geom_point(aes(country,mean_prop_coastal,colour=nuts1),size=2.5)+
  ylim(0,1)+
  ylab("Mean Proportion Total Nights Coastal")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Mean Proportion Coastal Accommodation Stays at NUTS1 level (2012-2014)")

```

### 4.4 Apply proportion coastal to NUTS2 time series data 

#### 4.4.1 Create a NUTS1 column for joining 
```{r}
str(accom_nuts2)

accom_nuts3 = accom_nuts2 %>%
              mutate(nuts1 = substr(nuts2,1,3))

```

#### 4.4.2 Join timeseries and mean proportion coastal 
```{r join time series and mean proportion coastal}

accom_nuts4 = inner_join(accom_nuts3,accom_coast_nuts2,
                        by=c("country","country_abb","basin","rgn_id","nuts1"))%>%
              filter(year>=2000) %>% ## select only data from 2000 onwards
              select(country,country_abb,nuts1,nuts2,nuts_name,
                     rgn_id,basin,year,value,mean_prop_coastal,pop,pop_km2,area)%>%
              dplyr::rename(night_stays = value)

```

#### 4.4.3 Apply proportional coastal to the times series 
```{r Apply proportional coastal to the times series}
accom_nuts5 = accom_nuts4%>%
              mutate(night_stays_coastal = night_stays * mean_prop_coastal)

```

#### 4.4.4 Plot coastal night stays times series 
```{r  Plot coastal night stays times series}
ggplot(accom_nuts5)+
  geom_point(aes(year,night_stays_coastal,colour=nuts1))+
  facet_wrap(~country)+
  ylab("Coastal Total Night Stays NUTS2")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Coastal Total Night Stays NUTS2 level")
 
```

### 4.5 Determine NUTS2 population allocation among BHI regions 

#### 4.5.1 Identify total NUTS2 population in the 25km buffer 
Sum across BHI regions associated with a NUTS2. This is the same for all years as population data comes from a single year.  

```{r NUTS3 population in the buff }

nuts2_buffer_pop= accom_nuts5 %>%
                  select(nuts2,pop,area)%>%
                  distinct()%>% ## because duplicated for each year
                  group_by(nuts2)%>%
                  summarise(pop_nuts2 = sum(pop),
                            area_nuts2 = sum(area))%>%
                  ungroup()

```


#### 4.5.2 Join the total NUTS2 area and population to the per BHI region data
```{r join total nuts2 area and pop to accom data}
accom_nuts6  = nuts2_buffer_pop %>%
                  full_join(., accom_nuts5, by="nuts2")


```


#### 4.5.3 Calculate the population fraction in a BHI region from a NUTS2 out of the NUTS2 total buffer population
```{r calculate nuts2 prop for each region}
accom_nuts6 = accom_nuts6 %>%
              mutate(bhi_pop_prop = pop / pop_nuts2)

```

#### 4.5.4 Plot the population fraction for each region 

```{r plot the population fraction for bhi regions}
ggplot(accom_nuts6)+
  geom_point(aes(country,bhi_pop_prop,colour=nuts1))+
  facet_wrap(~rgn_id)+
  ylab("Population proportion")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6))+
  ggtitle("Proportion of NUTS2 population for each BHI region")

ggplot(accom_nuts6)+
  geom_point(aes(rgn_id,bhi_pop_prop,colour=nuts1))+
  facet_wrap(~country)+
  ylab("Population proportion")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6))+
  ggtitle("Proportion of NUTS2 population for each BHI region")
 
```


#### 4.6 Calculate BHI night stays   

#### 4.6.1 Caclulate stays in BHI regions based on population allocation
```{r Calculate for each NUTS2 region the allocation among BHI regions}
accom_nuts7 = accom_nuts6 %>%
              select(-pop_nuts2,-area_nuts2,-nuts1,-nuts2,-nuts_name,-night_stays,-mean_prop_coastal,
                     pop,-pop_km2,-area) %>%
              mutate(night_stays_coastal_allocated = night_stays_coastal * bhi_pop_prop) %>%
              select(-night_stays_coastal,-bhi_pop_prop)%>%
              group_by(country,country_abb,basin, rgn_id,year)%>%
              summarise(bhi_coastal_stays = sum(night_stays_coastal_allocated),
                        bhi_pop = sum(pop, na.rm=TRUE))%>%
              ungroup()%>%
              mutate(bhi_coastal_stays_per_cap = bhi_coastal_stays/bhi_pop)
              
head(accom_nuts7)

```

#### 4.6.2 Plot BHI night stays
```{r plot bhi night stays}

ggplot(accom_nuts7)+
  geom_point(aes(year,bhi_coastal_stays))+
  facet_wrap(~rgn_id, scales="free_y")+
  ylab("Number of Nights")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6))+
  ggtitle("BHI Coastal Stays")

ggplot(accom_nuts7)+
  geom_point(aes(year,bhi_coastal_stays_per_cap))+
  facet_wrap(~rgn_id, scales="free_y")+
  ylab("Number of Nights Per Capita")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6))+
  ggtitle("BHI Coastal Stays Per Capita")


ggplot(accom_nuts7)+
  geom_point(aes(year,bhi_coastal_stays_per_cap, colour=factor(rgn_id)))+
  facet_wrap(~country, scales="free_y")+
  ylab("Number of Nights Per Capita")+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6))+
  ggtitle("BHI Coastal Stays Per Capita")

```


## 5. Prepare and Save Data Layers
Use per capita night stays
### 5.1 Prepare layer
```{r prepare layer for layers}
tr_layer = accom_nuts7 %>%
            select(rgn_id,year,bhi_coastal_stays_per_cap)%>%
            arrange(rgn_id,year)

## check max year
tr_layer %>% select(rgn_id,year)%>% filter(!is.na(year)) %>% group_by(rgn_id) %>% summarise(max_year= max(year)) %>% ungroup() %>% print(n=42)
## last year is 2014 for all regions!

```

### 5.2 Write layer to csv
```{r write tr layer to csv}

write.csv(tr_layer, file.path(dir_layers,"tr_accommodation_stays_bhi2015.csv"),row.names = FALSE)

```


## 6. Explore Status and Trend calculation
Moving window reference
### 6.1 Read in layers
```{r}
tr_layer 

```

### 6.2 Set Parameters
```{r set parameters}
# set lag window for reference point calculations
  lag_win = 5  # 5 year lag
  trend_yr = 4 # to select the years for the trend calculation, select most recent year - 4 (to get 5 data points)
  bhi_rgn = data.frame(rgn_id = as.integer(seq(1,42,1))) #unique BHI region numbers to make sure all included with final score and trend

```


### 6.3 Calculate status
```{r calculate status}
## calculate status time series
tr_status_score = tr_layer %>%
    dplyr::rename(nights = bhi_coastal_stays_per_cap) %>%
    filter(!is.na(nights)) %>%
    group_by(rgn_id)%>%
    mutate(year_ref = lag(year, lag_win, order_by=year),
           ref_val = lag(nights, lag_win, order_by=year)) %>% #create ref year and value which is value 5 years preceeding within a BHI region
    arrange(year)%>%
    filter(year>= max(year)- lag_win)%>% #select only the previous 5 years from the max year
    ungroup() %>%
    mutate(rgn_value = nights/ref_val) %>% #calculate rgn_value per year, numerator of score function
    select(rgn_id,year,rgn_value)%>%
    mutate(status = pmin(1,rgn_value)) ## if regions have no data, are not included here, final year will be included below

 ## select last year of data in timeseries for status
  tr_status = tr_status_score %>%
    group_by(rgn_id) %>%
    summarise_each(funs(last), rgn_id, status) %>%  #this will be all same year because of code above selecting the max year
    full_join(bhi_rgn, .,by="rgn_id")%>% #all regions now listed, have NA for for status
    mutate(score = status*100,
            dimension = 'status') %>% ##scale to 0 to 100
     select(region_id = rgn_id,score, dimension)


```

### 6.4 Plot Status
```{r plot tr status}

## plot tr status time series
ggplot(tr_status_score)+
  geom_point(aes(year,status))+
  facet_wrap(~rgn_id)+
  ylim(0,1)+
  ylab("Status")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
        axis.text.y = element_text(size=6))+
  ggtitle("TR status time series")

## plot tr status time series, less range on y-axis
ggplot(tr_status_score)+
  geom_point(aes(year,status))+
  facet_wrap(~rgn_id)+
  ylim(.8,1)+
  ylab("Status")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
        axis.text.y = element_text(size=6))+
  ggtitle("TR status time series - different y-axis range")


## plot final year (2014) status

ggplot(tr_status)+
  geom_point(aes(region_id,score), size=2)+
  ylim(0,100)+
  ylab("Status score")+
  xlab("BHI region")+
  ggtitle("TR status score in 2014")

```


### 6.5 Calculate Trend
```{r calculate trend}
  
  ## calculate trend for 5 years (5 data points)
  ## years are filtered tr_status_score
      tr_trend = tr_status_score %>%
        filter(year >= max(year - trend_yr))%>%                #select five years of data for trend
        filter(!is.na(status)) %>%                              # filter for only no NA data because causes problems for lm if all data for a region are NA
        group_by(rgn_id) %>%
        mutate(regr_length = n())%>%                            #get the number of status years available for greggion
        filter(regr_length == (trend_yr + 1))%>%                   #only do the regression for regions that have 5 data points
          do(mdl = lm(status ~ year, data = .)) %>%             # regression model to get the trend
            summarize(rgn_id = rgn_id,
                      score = coef(mdl)['year'] * lag_win)%>%
        ungroup() %>%
        full_join(bhi_rgn, .,by="rgn_id")%>%  #all regions now listed, have NA for trend #should this stay NA?  because a 0 trend is meaningful for places with data
        mutate(score = round(score, 2),
               dimension = "trend") %>%
        select(region_id = rgn_id, dimension, score) %>%
        data.frame()


```


### 6.6 Plot trend

```{r plot tr trend}
ggplot(tr_trend)+
  geom_point(aes(region_id,score), size=2)+
  geom_hline(yintercept = 0)+
  ylim(-1,1)+
  ylab("Status score")+
  xlab("BHI region")+
  ggtitle("TR 5 yr trend score")



```



### 6.7Plot trend and status together
```{r plot tr trend and status together}

plot_tr = bind_rows(tr_status,tr_trend)

ggplot(plot_tr)+
  geom_point(aes(region_id,score),size=2.5)+
  facet_wrap(~dimension, scales = "free_y")+
  ylab("Score")+
  ggtitle("TR Status and Trend")


```




## 7. Issues or Concerns

### 7.1 Shapefile assignment issues
#### 7.2.1 Able to fix manually
See #### 4.1.4
#### 7.2.2 Not able to fix mannually
BHI region 21 not assigned to any NUTS2 regions - despite clear association with PL63. PL63 split only between BHI 17 and BHI 18

### 7.2 Name discrepancies between datasets
#### 7.2.1 Finnish NUTS2 renamed
See #### 4.1.3
Shapefiles have names from 2006, accommodation datasets have newer names
![Map of old NUTS2 names for GUlf of Finland](BHI_regions_NUTS2_plot.png?raw=true)  
![Map of new NUTS2 names for GUlf of Finland](new_FI_nuts2.png?raw=true)  

Challenge because of coasts: New FI1C is associated with both the Gulf of Finland and the Aland Sea. New FI1B has a small fraction associated with Aland Sea, the rest is Gulf of Finland.  Old FI18, contains both FI1C and FI1B. 

Old FI1A seems to be the same along the coast as the new FI1D but new FI1D covers inland areas previously in FI13

Solution:  Combine data from the new regions (FI1C and FI1B), and apply population fraction from the older region (FI18). Apply FI1A old fraction to new (FI1D)

Downsides to this solution: Helsinki is in FI1B, which would assign almost entirely to BHI 32 and whereas FI1C would divide more equally btween BHI 36 and BHI 32. Therefore, combining these regions in order to apply the division generated from the old region may have a different result.  

### 7.3 Spatial resolution of coastal allocation.
Differs among countries. Within Germany, NUTS area available differs.  
