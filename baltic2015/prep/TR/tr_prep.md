Tourism & Recreation (TR) Goal Data Preparation
================

-   [1. Background](#background)
    -   [1.1 Goal description](#goal-description)
    -   [1.2 Model and Data](#model-and-data)
    -   [1.3 Reference point](#reference-point)
    -   [1.4 Other considerations for *OHI-BHI 2.0*](#other-considerations-for-ohi-bhi-2.0)
-   [2. Data](#data)
    -   [Regional Accommodation Stays Data](#regional-accommodation-stays-data)
    -   [Regional Accommodation Stays Coastal/Non-Coastal Data](#regional-accommodation-stays-coastalnon-coastal-data)
-   [3. Goal Model](#goal-model)
    -   [3.1 Status Calculation](#status-calculation)
    -   [3.2 Reference point](#reference-point-1)
    -   [3.3 Trend calculation](#trend-calculation)
-   [4. Data Layer Preparation](#data-layer-preparation)
    -   [4.1 Data cleaning and organizing](#data-cleaning-and-organizing)
    -   [4.2 Join datasets](#join-datasets)
    -   [4.3 Proportion coastal stays at the NUTS1 level](#proportion-coastal-stays-at-the-nuts1-level)
    -   [4.4 Apply proportion coastal to NUTS2 time series data](#apply-proportion-coastal-to-nuts2-time-series-data)
    -   [4.5 Determine NUTS2 population allocation among BHI regions](#determine-nuts2-population-allocation-among-bhi-regions)
-   [5. Prepare and Save Data Layers](#prepare-and-save-data-layers)
    -   [5.1 Prepare layer](#prepare-layer)
    -   [5.2 Write layer to csv](#write-layer-to-csv)
-   [6. Explore Status and Trend calculation](#explore-status-and-trend-calculation)
    -   [Status calculation](#status-calculation-1)
    -   [6.4 Plot Status](#plot-status)
    -   [6.5 Calculate Trend](#calculate-trend)
    -   [6.6 Plot trend](#plot-trend)
    -   [6.7 Plot trend and status together](#plot-trend-and-status-together)
-   [7. Issues or Concerns](#issues-or-concerns)
    -   [7.1 Shapefile assignment issues](#shapefile-assignment-issues)
    -   [7.2 Name discrepancies between datasets](#name-discrepancies-between-datasets)
    -   [7.3 Spatial resolution of coastal allocation.](#spatial-resolution-of-coastal-allocation.)

1. Background
-------------

### 1.1 Goal description

Tourism and recreation in coastal areas is a major component of thriving coastal communities and a measure of how much people value ocean systems, i.e. by traveling to coastal and ocean areas. This goal is not about the revenue or livelihoods that are generated by tourism and recreation (that is captured in the livelihoods goal) but instead captures the value that people have for experiencing and enjoying coastal areas. Here we are using regional data on nights spent at tourist accommodation establishments to represent how much people value and enjoy the coastal regions.

### 1.2 Model and Data

Tourism model incorporates the nights of staty in accommodations and compare that to the reference point.

We used Eurostat dataset on [nights spent at tourist accommodation establishments](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2&lang=en) by all NUTS regions. \[tour\_occ\_nin2\]

### 1.3 Reference point

103% of the highest number of night of stay in the past five years. This is based on [EU's Blue Growth Strategy](http://ec.europa.eu/maritimeaffairs/policy/coastal_tourism/index_en.htm), which states "the coastal and maritime tourism sector has been identified as an area with special potential to foster a smart, sustainable and inclusive Europe. It is the biggest maritime sector in terms of gross value added and employment and is expected to grow by 2-3% by 2020."

### 1.4 Other considerations for *OHI-BHI 2.0*

MISSING data for region 19, 22, 30, 33

2. Data
-------

### Regional Accommodation Stays Data

Eurostat dataset on Nights spent at tourist accommodation establishments by all NUTS regions with the finest scale spatial resolution at NUTS2. [tour\_occ\_nin2](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2&lang=en)

Download Date: 10 Feb 2016, Download By: Jennifer Griffiths

[Metadata](http://ec.europa.eu/eurostat/cache/metadata/en/tour_occ_esms.htm)

Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2)

Selected all accommodation categories combined: hotels; holiday and other short-stay accommodation; camping grounds, recreational vehicle parks and trailer parks

Select all years available: 1990-2014

Missing data indicated by colon (:)

### Regional Accommodation Stays Coastal/Non-Coastal Data

Eurostat dataset on Nights spent at tourist accommodation establishments by coastal and non-coastal area from 2012 onwards. These were download for all available region levels. [tour\_occ\_nin2c](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2c&lang=en)
Download Date: 10 Feb 2016, Download By: Jennifer Griffiths

[Metadata](http://ec.europa.eu/eurostat/cache/metadata/en/tour_occ_esms.htm)

Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2)

Selected all accommodation categories combined: hotels; holiday and other short-stay accommodation; camping grounds, recreational vehicle parks and trailer parks

Selected Total, and split between Coastal & non-coastal regions

Selected years available: 2012-2014

Missing data indicated by colon (:)

3. Goal Model
-------------

### 3.1 Status Calculation

Xtr = a\_r/a\_ref\_r

-   a\_r = number of nights spent in coastal accommodations in BHI region r
-   a\_ref\_r = a\_r - 5
-   r = BHI region
-   a\_r = (proportion population in 25km buffer in nuts2 association with r) x a\_c
-   n = NUTS2 region

-   a\_c = coastal accommodation stays in NUTS2 region n
-   a\_c = a\_n x c\_n1
-   a\_n = accomodation stays in NUTS2 region\_n
-   c\_n1 = mean proportion of accommodations stays that are coastal at the NUTS1 level

### 3.2 Reference point

We set reference point as 3% more than the most recent year. This figure came from [Study in support of policy measures for maritime and coastal tourism at EU level](http://ec.europa.eu/maritimeaffairs/documentation/studies/documents/study-maritime-and-coastal-tourism_en.pdf)

"As part of EU's Blue Growth strategy, the coastal and maritime tourism sector has been identified as an area with special potential to foster a smart, sustainable and inclusive Europe. It is the biggest maritime sector in terms of gross value added and employment, and is expected to grow by 2-3% by 2020."

### 3.3 Trend calculation

Linear regression fit to the most recent 5 status years.

4. Data Layer Preparation
-------------------------

``` r
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide")

## set directory and load libraries
source('~/github/bhi/baltic2015/prep/common.r')
dir_tr = file.path(dir_prep, 'TR')

## add a README.md to the prep directory 
create_readme(dir_tr, 'tr_prep.rmd') 
```

### 4.1 Data cleaning and organizing

#### 4.1.1 Read in data

``` r
## accomodation stays time series by NUTS region
accom = read.csv(file.path(dir_tr, "tr_data_database/accom.csv"), stringsAsFactors = FALSE)
# dim(accom)

## accomodation stays for 2012-2014 by NUTS region divided by the coastal and non-coastal fractions
accom_coast = read.csv(file.path(dir_tr, "tr_data_database/accom_coast.csv"), stringsAsFactors = FALSE)
# dim(accom_coast)

## NUTS2 population and area by BHI region fraction
nuts2_pop_area = read_csv(file.path(dir_tr, "tr_data_database/NUTS2_BHI_ID_Pop_density_in_buffer.csv"))

# dim(nuts2_pop_area)

## european country names and abbreviations
eu_names = read.csv(file.path(dir_prep,"EUcountrynames.csv"), sep=";", stringsAsFactors =FALSE)
```

#### 4.1.2 Clean Data

##### Acommodation stays time series

``` r
## Acommodation stays time series
# str(accom)
## need to remove the BHI_ID columns - these are from an old join to the BHI shapefile, not relevant now.
## need to rename columns
## these data contain all NUTS levels from level 2 up, need to have them be just NUTS2 -- will do this when join to NUTS2 population data, will then have only the NUTS2 from the shapefile. 
## value has : for NA, fix

accom1 = accom %>%
         select(-contains("BHI"), - TIME_LABEL,-UNIT,-INDIC_TO, -NACE_R2 ) %>% ## remove BHI related columns, and other columns that are not needed
         dplyr::rename(year = TIME,
                       nuts = GEO, 
                       nuts_name = GEO_LABEL,
                       dat_descrip = INDIC_TO_LABEL,
                       unit = UNIT_LABEL,
                       dat_descrip2 = NACE_R2_LABEL,
                       value = Value,
                       flag_notes = Flag.and.Footnotes) %>%
          mutate(value = ifelse(value == ":", NA, value)) %>%
          mutate(value = as.numeric(value)) %>%
  mutate(dat_descrip = "Nights spent total",
                      dat_descrip2 = "Hotels and holiday and other short-stay accommodation and camping grounds recreational vehicle parks and trailer parks" ) ## fix so no commas or semi-colons

str(accom1)

## check flags
accom1 %>% select(flag_notes) %>% distinct()
accom1 %>% filter(flag_notes %in% c("c","e","u","be","b")) %>% select(year, nuts,value, flag_notes) ## very few apply to Baltic countries, u is biggest concern = "low reliability"
accom1 %>% filter(flag_notes %in% c("u","bu")) %>% select(year, nuts,value, flag_notes) ## not baltic countries

accom1 = accom1 %>%
        select(-flag_notes)
```

##### Coastal / non-coastal data

Clean to get NUTS1 - higher resolution available for some areas (parts of Finland, German, Poland) but is not consistent. However, NUTS1 does differ among countries. In Denmark, Estonia, Latvia, and Lithuania: NUTS1 is the entire country. *Note for Denmark: this means non-Baltic coast is included*

In Finland, Aland is one region and the rest of the country is another.

In Sweden there are 3 regions in the entire country, and 1 region includes non-Baltic coast. All have substantial inland area.

Germany and Poland each have 2 regions that are NUTS1 that border the Baltic.

![See NUTS1 locations here](nuts1_regions_eurostat_image.png?raw=true)

``` r
## Coastal / non-coastal data
## need to remove the BHI_ID columns - these are from an old join to the BHI shapefile, not relevant now.
## need to rename columns
## these data are at multiple spatial resolutions, need to figure out finest scale resolution, export and do manually.  Differs by country. Also differs within Germany.

# str(accom_coast)

accom_coast1 = accom_coast %>%
         select(-contains("BHI"), -TERRTYPO, - TIME_LABEL, -UNIT, -INDIC_TO, -NACE_R2 ) %>% ## remove BHI related columns, and other columns that are not needed
         dplyr::rename(year = TIME,
                       nuts = GEO, 
                       nuts_name = GEO_LABEL,
                       location = TERRTYPO_LABEL,
                       dat_descrip = INDIC_TO_LABEL,
                       unit = UNIT_LABEL,
                       dat_descrip2 = NACE_R2_LABEL,
                       value = Value,
                       flag_notes = Flag.and.Footnotes) %>%
          mutate(value = ifelse(value == ":", NA, value)) %>%
          mutate(value = as.numeric(value))

# str(accom_coast1)

accom_coast %>% select(TERRTYPO, TERRTYPO_LABEL) %>% distinct()

## figure out which are the NUTS1 abbreviations from the other NUTS level abbreviations, select only NUTS1
accom_coast2 = accom_coast1 %>%
               mutate(country_abb = substr(nuts,1,2)) %>% ## set up country abbreviation
               left_join(., eu_names, by="country_abb") %>% ## join to eu country names
               filter(grepl("Denmark|Estonia|Finland|Germany|Latvia|Lithuania|Poland|Sweden", country)) %>% ## select only Baltic countries to make it easier
               mutate(dat_descrip = "Nights spent total",
                      dat_descrip2 = "Hotels and holiday and other short-stay accommodation and camping grounds recreational vehicle parks and trailer parks" ) %>% ## fix so no commas or semi-colons
                mutate(nuts0 = substr(nuts, 1, 2),
                       nuts1 = substr(nuts, 1, 3),
                       nuts1 = ifelse(nuts0==nuts1, NA, nuts1),
                       nuts_select = ifelse(nuts1 == nuts, 1, 0)) %>% ## select data that are NUTS1
                filter(nuts_select == 1 ) %>% 
                select(-nuts_select,-nuts,-nuts0,-nuts_name) 
                     
## check flags
# accom_coast2 %>% select(flag_notes) %>% distinct() ## b
# accom_coast2 %>% filter(flag_notes == "b") ## just for 2012 for LV and LT

accom_coast2 = accom_coast2 %>%
               select(-flag_notes) %>%
               select(country, country_abb, nuts1, year, location, value, unit, dat_descrip, dat_descrip2)

# head(accom_coast2)
```

##### NUTS2 population data

``` r
## nuts2 population data
#str(nuts2_pop_area)

nuts2_pop_area1 = nuts2_pop_area %>%
                  select(-PopUrb,-PopRur,-PopUrb_density_in_NUTS2_buffer_per_km2,-PopRur_density_in_NUTS2_buffer_per_km2, -HELCOM_ID) %>%
                  dplyr::rename(rgn_id = BHI_ID,
                                nuts2 = NUTS_ID,
                                pop = PopTot,
                                pop_km2 = PopTot_density_in_NUTS2_buffer_per_km2,
                                country_abb= CNTR_CODE,
                                country = rgn_nam,
                                basin = Subbasin,
                                area = NUTS2_area_in_BHI_buffer_km2) %>% 
                  mutate(country_abb = substr(nuts2, 1, 2)) #change three letter code to two letter code 

# str(nuts2_pop_area1)
```

#### 4.1.3 Check NUTS2 names from Finland

Shapefiles have names from 2006, check accom1 and accom\_coast1 to see if the names have been updated, will need to fix.

![Map of old NUTS2 names for GUlf of Finland](BHI_regions_NUTS2_plot.png?raw=true)

![Map of new NUTS2 names for GUlf of Finland](new_FI_nuts2.png?raw=true)

``` r
accom1 %>% filter(grepl("FI", nuts)) %>% select(nuts, nuts_name) %>% distinct()
## These are the newer region names : FI1B, FI1C, FI1D

accom_coast1 %>% filter(grepl("FI", nuts)) %>% select(nuts, nuts_name) %>% distinct()
## These are the newer region names : FI1B, FI1C, FI1D

nuts2_pop_area1 %>% filter(grepl("FI", nuts2)) %>% select(nuts2) %>% distinct()
## These are the older region names: FI18, FI1A

## Challenge because of coasts
## FI1C is associated with both the Gulf of Finland and the Aland Sea. FI1B has a small fraction associated with Aland Sea, the rest is Gulf of Finland

## Old FI18, contains both FI1C and FI1B.  May need to combine data from the new regions, and apply fraction from the older region.  Helsinki is in FI1B, which would assign almost entirely to BHI 32 and whereas FI1C would divide more equally btween BHI 36 and BHI 32. Therefore, combining these regions in order to apply the division generated from the old region may have a different result.

## old FI1A seems to be the same along the coast as the new FI1D but new FI1D covers inland areas previously in FI13

## Do this after joining accom and accom_coast with the nuts2_pop_area data, will have to add these regions back in.
```

#### 4.1.4 Check for incorrectly assigned NUTS2 regions to BHI regions and fix

Note - (as in NUTS3 assignment issues see ECO)

``` r
## write to csv, fix manually, re-import csv
misassigned_nuts2 = nuts2_pop_area1 %>% select(nuts2,country,rgn_id)

#write.csv(misassigned_nuts2 , file.path(dir_tr, "misassigned_nuts2.csv"), row.names=FALSE)

## read in corrected assignments

corrected_nuts2 = read.csv(file.path(dir_tr,"misassigned_nuts2_manually_corrected.csv"),sep=";",stringsAsFactors = FALSE) %>%       rbind(c("PL63","Poland", as.integer(21),NA,NA, "", as.integer(21), 'Poland')) %>%
      mutate(rgn_id = as.integer((rgn_id)),
             X.correct_BH_ID = as.integer(X.correct_BH_ID))

## join nuts2_pop_area1 with corrected data and fix

nuts2_pop_area2 = nuts2_pop_area1 %>%
                  full_join(., corrected_nuts2,
                            by=c("rgn_id","nuts2","country")) %>%
                 select(-country,-rgn_id,-incorrect,-BHI_ID_manual, -X.country_manual) %>%
                 dplyr::rename(country =X.correct_country,
                               rgn_id = X.correct_BH_ID) %>%
                  select(rgn_id,nuts2,country,country_abb,basin,pop,pop_km2,area) %>%
                  group_by(rgn_id, nuts2, country,country_abb,basin) %>%
                  summarise(pop =sum(pop),
                            pop_km2 = sum(pop_km2),
                            area = sum(area)) %>% ## some regions occurr twice because of correcting the assignment, sum to get single value for each region
                  ungroup()


# str(nuts2_pop_area2)
```

### 4.2 Join datasets

#### 4.2.1 Join accom times series with nuts pop and area

Join data with inner join, this will exclude Finland areas with name mismatches. Fix Finnish data and add back into the dataset.

``` r
accom_nuts1 = inner_join(accom1, nuts2_pop_area2,
                         by=c("nuts"="nuts2")) %>%
              dplyr::rename(nuts2 = nuts)

# dim(accom1)##11250     8
# dim(nuts2_pop_area2) ## 60 8
# dim(accom_nuts1) ##1400  14

# str(accom_nuts1) ## this is now missing the Finnish data where there are name discrepancies

## Get Finnish data renamed so that accommodating and population data match
fi_accom_newnuts = accom1 %>%
                   filter(nuts %in% c("FI1C","FI1B", "FI1D"))
# fi_accom_newnuts

fi_nuts_oldnuts = nuts2_pop_area2 %>%
                  filter(nuts2 %in% c("FI18","FI1A"))

# fi_nuts_oldnuts

## assign old nuts names to accom data
fi_accom_newnuts1 = fi_accom_newnuts %>%
                    mutate(nuts_old = ifelse(nuts == "FI1C","FI18",
                                      ifelse(nuts == "FI1B", "FI18",
                                      ifelse(nuts == "FI1D", "FI1A",""))),
                           nuts_name_old= ifelse(nuts == "FI1C" | nuts == "FI1B","old region",nuts_name )) %>%
                    select(-nuts, -nuts_name) %>%
                    dplyr::rename(nuts=nuts_old,
                                  nuts_name = nuts_name_old) %>%
                    group_by(year,nuts,nuts_name,dat_descrip,unit,dat_descrip2) %>%
                    summarise(value = sum(value)) %>% ## combine all data from contributing sources into old FI unit
                    ungroup()
                        
# head(fi_accom_newnuts1) ## there are NA but were NA for all regions in those years

## join fi accom to fi pop and area

fi_accom_correct_nuts = full_join(fi_accom_newnuts1, fi_nuts_oldnuts,
                          by=c("nuts"="nuts2")) %>%
                          dplyr::rename(nuts2=nuts) %>%
                          select(year,nuts2,nuts_name,dat_descrip,unit,dat_descrip2,
                                 value,rgn_id,country,country_abb,basin, pop,
                                 pop_km2,area)



### bind to rest of data
# colnames(fi_accom_correct_nuts)
# colnames(accom_nuts1)

accom_nuts2 = bind_rows(accom_nuts1, fi_accom_correct_nuts)
```

#### 4.2.2 Plot and check joined accom times series with NUTS population and area data

``` r
ggplot(accom_nuts2) +
  geom_point(aes(year,value, colour=nuts2)) +
  geom_line(aes(year,value, colour=nuts2)) +
  facet_wrap(~country, scale="free_y") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Time series accommodation stays NUTS2")
```

![](tr_prep_files/figure-markdown_github/plot%20accom_nuts2%20joined%20data-1.png)

#### 4.2.3 Check to see if BHI regions are missing

``` r
 accom_nuts2 %>% select(rgn_id) %>% distinct() %>% arrange(rgn_id)

## there are 38 regions

##missing: 19, 22, 30, 33

## expected missing - 19,22, and 33 from Russia
## 30 has no coastline
```

#### 4.2.4 Join accom\_coast data with NUTS population and area data

Note: since we are using Level 1 data, the Finnish mismatches are not relevant here.

``` r
## Join to nuts area and population data
## first create nuts1 level for nuts pop and ear
nuts2_pop_area3 = nuts2_pop_area2 %>%
                  mutate(nuts1 = substr(nuts2,1,3),
                         nutslevel_pop = nuts2) %>%
                  select(-nuts2)

## Join
accom_coast_nuts =  inner_join(accom_coast2, nuts2_pop_area3,
                               by =c("country","country_abb","nuts1"))

## are there BHI regions missing?
#  accom_coast_nuts %>% select(rgn_id) %>% distinct() %>% arrange(rgn_id)

## 38 regions

## missing are:

## Russia 19, 22,33

## No coastal area 30
```

#### 4.2.5 Plot coastal and noncoastal stays at NUTS1 level

``` r
ggplot(accom_coast_nuts) +
  geom_point(aes(year, value, shape=location, colour=nuts1)) +
  scale_shape_manual(values=c(0, 17, 8)) +
  facet_wrap(~country) +
  ylab("Total Nights") +
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Accommodation Stays by Location Type at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20coastal%20noncoastal%20stays%20nuts1-1.png)

#### 4.2.6 Plot separate countries coastal and noncoastal stays at NUTS1 level

For countries with more than 1 NUTS1 region: Finland, Sweden, Poland, and Germany.

``` r
## Finland
ggplot(filter(accom_coast_nuts, country=="Finland")) +
  geom_point(aes(year,value, shape=location,colour=nuts1)) +
  scale_shape_manual(values=c(0,17,8)) +
  facet_wrap(~nuts1) +
  ylab("Total Nights") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("FI Accommodation Stays by Location Type at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20coastal%20noncoastal%20stays%20nuts1%20countries%20separate-1.png)

``` r
## Sweden
ggplot(filter(accom_coast_nuts, country=="Sweden")) +
  geom_point(aes(year,value, shape=location,colour=nuts1)) +
  scale_shape_manual(values=c(0,17,8)) +
  facet_wrap(~nuts1) +
  ylab("Total Nights") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("SE Accommodation Stays by Location Type at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20coastal%20noncoastal%20stays%20nuts1%20countries%20separate-2.png)

``` r
## Poland
ggplot(filter(accom_coast_nuts, country=="Poland")) +
  geom_point(aes(year,value, shape=location,colour=nuts1)) +
  scale_shape_manual(values=c(0,17,8)) +
  facet_wrap(~nuts1) +
  ylab("Total Nights") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("PL Accommodation Stays by Location Type at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20coastal%20noncoastal%20stays%20nuts1%20countries%20separate-3.png)

``` r
##Germany
ggplot(filter(accom_coast_nuts, country=="Germany")) +
  geom_point(aes(year,value, shape=location,colour=nuts1)) +
  scale_shape_manual(values=c(0,17,8)) +
  facet_wrap(~nuts1) +
  ylab("Total Nights") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("DE Accommodation Stays by Location Type at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20coastal%20noncoastal%20stays%20nuts1%20countries%20separate-4.png)

### 4.3 Proportion coastal stays at the NUTS1 level

#### 4.3.1 Calculate Proportion coastal

``` r
accom_coast_nuts1 = accom_coast_nuts %>%
                    select(-dat_descrip, -dat_descrip2, -unit) %>%
                    mutate(location = ifelse(location == "Total","total",
                                      ifelse(location == "Coastal area","coastal","noncoastal"))) %>%
                    spread(location, value) %>%
                    mutate(prop_coastal = coastal/total) %>%
                    select(-coastal, -total, -noncoastal, -pop,-pop_km2, -area) %>%
                    mutate(year = as.numeric(year))
```

#### 4.3.2 Plot proportion coastal NUTS1 accommodation stays

Very consistent across the three years

``` r
ggplot(accom_coast_nuts1) +
  geom_point(aes(year,prop_coastal,colour=nuts1)) +
  facet_wrap(~country) +
  ylim(0,1) +
  ylab("Proportion Total Nights Coastal") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Proportion Coastal Accommodation Stays at NUTS1 level")
```

![](tr_prep_files/figure-markdown_github/plot%20nuts1%20proportion%20coastal-1.png)

#### 4.3.3 Mean proportion coastal for each NUTS1 over the three years

``` r
accom_coast_nuts2 = accom_coast_nuts1 %>%
                    select(-year,-nutslevel_pop) %>%
                    group_by(country,country_abb,nuts1,rgn_id,
                             basin) %>%
                    summarise(mean_prop_coastal = mean(prop_coastal, na.rm=TRUE))
```

#### 4.3.4 Plot Mean proportion coastal accommodation stays for each NUTS1

``` r
ggplot(accom_coast_nuts2) +
  geom_point(aes(country,mean_prop_coastal,colour=nuts1),size=2.5) +
  ylim(0,1) +
  ylab("Mean Proportion Total Nights Coastal") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Mean Proportion Coastal Accommodation Stays at NUTS1 level (2012-2014)")
```

![](tr_prep_files/figure-markdown_github/Plot%20Mean%20proportion%20coastal%20for%20each%20NUTS1-1.png)

### 4.4 Apply proportion coastal to NUTS2 time series data

#### 4.4.1 Create a NUTS1 column for joining

``` r
# str(accom_nuts2)

accom_nuts3 = accom_nuts2 %>%
              mutate(nuts1 = substr(nuts2,1,3))
```

#### 4.4.2 Join timeseries and mean proportion coastal

``` r
accom_nuts4 = inner_join(accom_nuts3,accom_coast_nuts2,
                        by=c("country","country_abb","basin","rgn_id","nuts1")) %>%
              filter(year>=2000) %>% ## select only data from 2000 onwards
              select(country, country_abb, nuts1, nuts2, nuts_name,
                     rgn_id, basin, year, value, mean_prop_coastal, pop, pop_km2, area) %>%
              dplyr::rename(night_stays = value)
```

#### 4.4.3 Apply proportional coastal to the times series

``` r
accom_nuts5 = accom_nuts4%>%
              mutate(night_stays_coastal = night_stays * mean_prop_coastal)
```

#### 4.4.4 Plot coastal night stays times series

``` r
ggplot(accom_nuts5) +
  geom_point(aes(year,night_stays_coastal,colour=nuts1)) +
  facet_wrap(~country) +
  ylab("Coastal Total Night Stays NUTS2") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Coastal Total Night Stays NUTS2 level")
```

![](tr_prep_files/figure-markdown_github/Plot%20coastal%20night%20stays%20times%20series-1.png)

### 4.5 Determine NUTS2 population allocation among BHI regions

#### 4.5.1 Identify total NUTS2 population in the 25km buffer

Sum across BHI regions associated with a NUTS2. This is the same for all years as population data comes from a single year.

``` r
nuts2_buffer_pop= accom_nuts5 %>%
                  select(nuts2,pop,area) %>%
                  distinct() %>% ## because duplicated for each year
                  group_by(nuts2) %>%
                  summarise(pop_nuts2 = sum(pop),
                            area_nuts2 = sum(area)) %>%
                  ungroup()
```

#### 4.5.2 Join the total NUTS2 area and population to the per BHI region data

``` r
accom_nuts6  = nuts2_buffer_pop %>%
                  full_join(., accom_nuts5, by="nuts2")
```

#### 4.5.3 Calculate the population fraction in a BHI region from a NUTS2 out of the NUTS2 total buffer population

``` r
accom_nuts6 = accom_nuts6 %>%
              mutate(bhi_pop_prop = pop / pop_nuts2)
```

#### 4.5.4 Plot the population fraction for each region

``` r
ggplot(accom_nuts6) +
  geom_point(aes(country,bhi_pop_prop,colour=nuts1)) +
  facet_wrap(~rgn_id) +
  ylab("Population proportion") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6)) +
  ggtitle("Proportion of NUTS2 population for each BHI region")
```

![](tr_prep_files/figure-markdown_github/plot%20the%20population%20fraction%20for%20bhi%20regions-1.png)

``` r
ggplot(accom_nuts6) +
  geom_point(aes(rgn_id,bhi_pop_prop,colour=nuts1)) +
  facet_wrap(~country) +
  ylab("Population proportion") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6)) +
  ggtitle("Proportion of NUTS2 population for each BHI region")
```

![](tr_prep_files/figure-markdown_github/plot%20the%20population%20fraction%20for%20bhi%20regions-2.png)

#### 4.6 Calculate BHI night stays

#### 4.6.1 Caclulate stays in BHI regions based on population allocation

``` r
accom_nuts7 = accom_nuts6 %>%
              select(-pop_nuts2,-area_nuts2,-nuts1,-nuts2,-nuts_name,-night_stays,-mean_prop_coastal,
                     pop,-pop_km2,-area) %>%
              mutate(night_stays_coastal_allocated = night_stays_coastal * bhi_pop_prop) %>%
              select(-night_stays_coastal,-bhi_pop_prop) %>%
              group_by(country,country_abb,basin, rgn_id,year) %>%
              summarise(bhi_coastal_stays = sum(night_stays_coastal_allocated),
                        bhi_pop = sum(pop, na.rm=TRUE)) %>%
              ungroup() %>%
              mutate(bhi_coastal_stays_per_cap = bhi_coastal_stays/bhi_pop)
              
# head(accom_nuts7)
```

#### 4.6.2 Plot BHI night stays

``` r
ggplot(accom_nuts7) +
  geom_point(aes(year,bhi_coastal_stays)) +
  facet_wrap(~rgn_id, scales="free_y") +
  ylab("Number of Nights") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6)) +
  ggtitle("BHI Coastal Stays")
```

![](tr_prep_files/figure-markdown_github/plot%20bhi%20night%20stays-1.png)

``` r
ggplot(accom_nuts7) +
  geom_point(aes(year,bhi_coastal_stays_per_cap)) +
  facet_wrap(~rgn_id, scales="free_y") +
  ylab("Number of Nights Per Capita") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6)) +
  ggtitle("BHI Coastal Stays Per Capita")
```

![](tr_prep_files/figure-markdown_github/plot%20bhi%20night%20stays-2.png)

``` r
ggplot(accom_nuts7) +
  geom_point(aes(year,bhi_coastal_stays_per_cap, colour=factor(rgn_id))) +
  facet_wrap(~country, scales="free_y") +
  ylab("Number of Nights Per Capita") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
         axis.text.y = element_text(size=6)) +
  ggtitle("BHI Coastal Stays Per Capita")
```

![](tr_prep_files/figure-markdown_github/plot%20bhi%20night%20stays-3.png)

5. Prepare and Save Data Layers
-------------------------------

Use per capita night stays

### 5.1 Prepare layer

``` r
tr_layer = accom_nuts7 %>%
            select(rgn_id,year,bhi_coastal_stays_per_cap) %>%
            arrange(rgn_id,year)

## check max year
# tr_layer %>% select(rgn_id,year) %>% filter(!is.na(year)) %>% group_by(rgn_id) %>% summarise(max_year= max(year)) %>% ungroup() %>% print(n=42)
## last year is 2014 for all regions!

### SAVE also for VISUALIZE
tr_time_data =tr_layer %>%
                    select(rgn_id,
                           year,value = bhi_coastal_stays_per_cap) %>%
                    mutate(unit= "Nights in Coastal Accommodation per capita",
                           bhi_goal="LIV",
                           data_descrip = "NUTS2 Nights in Coastal Accommodation allocated to BHI region")

write.csv(tr_time_data, file.path(dir_baltic,'visualize/tr_time_data.csv'),row.names=FALSE)
```

### 5.2 Write layer to csv

``` r
write.csv(tr_layer, file.path(dir_layers,"tr_accommodation_stays_bhi2015.csv"),row.names = FALSE)
```

6. Explore Status and Trend calculation
---------------------------------------

<!-- Moving window reference -->
<!-- ### 6.1 Read in layers -->
<!-- ```{r} -->
<!-- tr_layer  -->
<!-- ``` -->
<!-- ### 6.2 Set Parameters -->
<!-- ```{r set parameters} -->
<!-- # set lag window for reference point calculations -->
<!--   lag_win = 5  # 5 year lag -->
<!--   trend_yr = 4 # to select the years for the trend calculation, select most recent year - 4 (to get 5 data points) -->
<!--   bhi_rgn = data.frame(rgn_id = as.integer(seq(1, 42, 1))) #unique BHI region numbers to make sure all included with final score and trend -->
<!-- ``` -->
<!-- ### 6.3 Calculate status -->
<!-- ```{r calculate status} -->
<!-- ## calculate status time series -->
<!-- tr_status_score = tr_layer %>% -->
<!--     dplyr::rename(nights = bhi_coastal_stays_per_cap) %>% -->
<!--     filter(!is.na(nights)) %>% -->
<!--     group_by(rgn_id) %>% -->
<!--     mutate(year_ref = lag(year, lag_win, order_by=year), -->
<!--            ref_val = lag(nights, lag_win, order_by=year)) %>% #create ref year and value which is value 5 years preceeding within a BHI region -->
<!--     arrange(year) %>% -->
<!--     filter(year>= max(year)- lag_win) %>% #select only the previous 5 years from the max year -->
<!--     ungroup() %>% -->
<!--     mutate(rgn_value = nights/ref_val) %>% #calculate rgn_value per year, numerator of score function -->
<!--     select(rgn_id,year,rgn_value) %>% -->
<!--     mutate(status = pmin(1,rgn_value)) ## if regions have no data, are not included here, final year will be included below -->
<!--  ## select last year of data in timeseries for status -->
<!--   tr_status = tr_status_score %>% -->
<!--     group_by(rgn_id) %>% -->
<!--     summarise_each(funs(last), rgn_id, status) %>%  #this will be all same year because of code above selecting the max year -->
<!--     full_join(bhi_rgn, .,by="rgn_id") %>% #all regions now listed, have NA for for status -->
<!--     mutate(score = status*100, -->
<!--             dimension = 'status') %>% ##scale to 0 to 100 -->
<!--      select(region_id = rgn_id,score, dimension) -->
<!-- ``` -->
### Status calculation

We will use the 103% of the highest "coastal\_stays\_per\_cap" (ie. coastal\_stays\_per\_cap \* 103%) within the past five years (2010-2014) as the reference point.

``` r
tr_status_score = tr_layer %>%
    dplyr::rename(nights = bhi_coastal_stays_per_cap) %>%
    filter(!is.na(nights)) %>%
    group_by(rgn_id) %>%
    filter(year > (max(year) - 5)) %>% 
    mutate(ref_nights = max(nights), 
           status_score = round(pmin(100, nights/ref_nights*100), 2)) %>% 
    # mutate(ref_nights = ifelse(year == 2014, nights*1.03, NA), # select ref point: (nights in 2014) * 103%
    #        ref_nights = ifelse(!is.na(ref_nights), ref_nights, ref_nights[year == 2014]), 
    #        status_score = round(pmin(100, nights/ref_nights*100), 2)) %>% 
    dplyr::select(rgn_id, year, status_score)
 
# select the most recent year for status    
tr_status = tr_status_score %>% 
  filter(year == max(year)) %>% 
  complete(rgn_id = full_seq(rgn_id, 1)) %>% 
  mutate(score = status_score,
         dimension = 'status') %>% ##scale to 0 to 100
  dplyr::select(rgn_id, score, dimension)

# MISSING 19, 22, 30, 33
```

### 6.4 Plot Status

``` r
## plot tr status time series, less range on y-axis
ggplot(tr_status_score) +
  geom_point(aes(year,status_score)) +
  facet_wrap(~rgn_id) +
  ylim(85,100) +
  ylab("Status") +
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain"),
        axis.text.y = element_text(size=6)) +
  ggtitle("TR status time series - different y-axis range")
```

![](tr_prep_files/figure-markdown_github/plot%20tr%20status-1.png)

``` r
## plot final year (2014) status

ggplot(tr_status) +
  geom_point(aes(rgn_id,score), size=2) +
  ylim(85,100) +
  ylab("Status score") +
  xlab("BHI region") +
  ggtitle("TR status score in 2014")
```

![](tr_prep_files/figure-markdown_github/plot%20tr%20status-2.png)

### 6.5 Calculate Trend

``` r
  ## calculate trend for 5 years (5 data points)
  ## years are filtered tr_status_score
tr_trend = tr_status_score %>%
  filter(year >= max(year - 5)) %>%                #select five years of data for trend
  filter(!is.na(status_score)) %>%                              # filter for only no NA data because causes problems for lm if all data for a region are NA
  group_by(rgn_id) %>%
  do(mdl = lm(status_score ~ year, data = .)) %>%             # regression model to get the trend
  summarize(rgn_id = rgn_id,
            score = round(coef(mdl)['year'] * 0.05, 2)) %>%
  ungroup() %>%
  complete(rgn_id = full_seq(rgn_id, 1)) %>%
  mutate(dimension = "trend") %>%
  select(rgn_id, dimension, score) %>%
  data.frame()
```

<!-- ### Trend calculation - alternative 1 with higher ref point -->
<!-- ```{r trend calc with higher ref point} -->
<!-- tr_trend_2 = tr_status_score_2 %>%  -->
<!--   filter(year %in% 2010:2014) %>%  -->
<!--   group_by(rgn_id) %>%  -->
<!--   do(dlm = lm(status_score ~ year, data = .)) %>%  -->
<!--   summarize(rgn_id = rgn_id, -->
<!--             score = round(coef(dlm)['year'] * 0.05, 2)) %>%  -->
<!--   mutate(score = round(score, 2), -->
<!--                dimension = "trend") %>% -->
<!--   dplyr::select(region_id = rgn_id, dimension, score) %>% -->
<!--   data.frame() -->
<!-- ``` -->
### 6.6 Plot trend

``` r
ggplot(tr_trend) +
  geom_point(aes(x = rgn_id, y = score)) +
  ggtitle('TR trend scores - with higher reference point')
```

![](tr_prep_files/figure-markdown_github/plot%20tr%20trend-1.png)

``` r
# ggplot(tr_trend) +
#   geom_point(aes(region_id,score), size=2) +
#   geom_hline(yintercept = 0) +
#   ylim(-1,1) +
#   ylab("Status score") +
#   xlab("BHI region") +
#   ggtitle("TR 5 yr trend score")
```

### 6.7 Plot trend and status together

``` r
plot_tr = bind_rows(tr_status,tr_trend)

ggplot(plot_tr) +
  geom_point(aes(rgn_id,score),size=2.5) +
  facet_wrap(~dimension, scales = "free_y") +
  ylab("Score") +
  ggtitle("TR Status and Trend")
```

![](tr_prep_files/figure-markdown_github/plot%20tr%20trend%20and%20status%20together-1.png)

7. Issues or Concerns
---------------------

### 7.1 Shapefile assignment issues

#### 7.2.1 Able to fix manually

See \#\#\#\# 4.1.4 \#\#\#\# 7.2.2 Not able to fix mannually BHI region 21 not assigned to any NUTS2 regions - despite clear association with PL63. PL63 split only between BHI 17 and BHI 18

### 7.2 Name discrepancies between datasets

#### 7.2.1 Finnish NUTS2 renamed

See \#\#\#\# 4.1.3 Shapefiles have names from 2006, accommodation datasets have newer names ![Map of old NUTS2 names for GUlf of Finland](BHI_regions_NUTS2_plot.png?raw=true)
![Map of new NUTS2 names for GUlf of Finland](new_FI_nuts2.png?raw=true)

Challenge because of coasts: New FI1C is associated with both the Gulf of Finland and the Aland Sea. New FI1B has a small fraction associated with Aland Sea, the rest is Gulf of Finland. Old FI18, contains both FI1C and FI1B.

Old FI1A seems to be the same along the coast as the new FI1D but new FI1D covers inland areas previously in FI13

Solution: Combine data from the new regions (FI1C and FI1B), and apply population fraction from the older region (FI18). Apply FI1A old fraction to new (FI1D)

Downsides to this solution: Helsinki is in FI1B, which would assign almost entirely to BHI 32 and whereas FI1C would divide more equally between BHI 36 and BHI 32. Therefore, combining these regions in order to apply the division generated from the old region may have a different result.

### 7.3 Spatial resolution of coastal allocation.

Differs among countries. Within Germany, NUTS area available differs.
