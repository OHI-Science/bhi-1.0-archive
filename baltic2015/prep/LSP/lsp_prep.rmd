---
title: "lsp_prep"
output: github_document
params: 
    datasource: csv
---

```{r setup, echo = FALSE}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')
library(stringr) # install.packages("stringr")

# source
source('~/github/bhi/baltic2015/prep/common.r') #for create_readme() function

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)

dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')
dir_prep = make_path('baltic2015/prep') # replaces  file.path(dir_baltic, 'layers')

# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))

# NOT used?
# dir_lsp   = file.path(dir_prep, 'LSP')

## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_lsp, 'lsp_prep.rmd') 
```

## 1. Background on MPA data  

### 1.1 Why MPAs?


## 2. MPA data  

### 2.1 Data source
#### 2.1.1 Shapefiles of MPA area
Shapefiles of current MPA areas were downloaded from [HELCOM MPAs Map Service](http://mpas.helcom.fi/apex/f?p=103:17::::::).  
    - Need to confirm date downloaded and date these data were last updated.  

#### 2.1.2 Management plan status csv
The status of the management plans associated with each MPA were downloaded from HELCOM's [MPA database] (http://mpas.helcom.fi/apex/f?p=103:40::::::) under the *Management Plans* tab.  Data were downloaded on 15 April 2016.  
    - Key columns in this csv file are "Site name" (MPA name) and "Management Plan status"  

There are three levels of management plan status that can be assigned to each MPA: *No plan*, *In development*, *Implemented*.  

A challenge is that each MPA can have multiple management plans associated with it. There is no limit to the number of plans not an ability to assess their relative importance. Different management plans for the same MPA can have different levels of implementation.  

**How to use this information*?*



## 3. LSP goal model overview
### 3.1 Status
Xlsp_country =  sum(w_i * MPA area)_m / Reference_pt_country  
    - Numerator is the sum over all MPAs within a country's EEZ of the MPA area weighted by the management status.  
    - w_i = value between 0 -1  
        - Need to assign weights to levels of management status.  
        - **One option**: *No plan* = 0.3, *In development* = .6, *Implemented* = 1.0.  **NEED FEEDBACK** 
    - Each country's status is applied to all BHI regions associated with that country.  

Reference_pt_country = 10% of the area in a country's EEZ is designated as an MPA and is 100% managed = 10% area country's EEZ  
    - This is based on the Convention on Biodiversity [target](https://www.cbd.int/sp/targets/rationale/target-11/)

### 3.2 Trend
##### 3.2.1 Alternative 1
MPA dbf contains the date the MPA was established. Therefore, we can calculate the cumulative area over time that are MPAs.  We can fit a cum. area ~ year. Calculate cumulative area from ealiest year of MPA established (1976) but for trend use the most recent 10 year period (2004 - 2013)?  It appears that countries mostly designate MPAs in chunks.

Only allow a positive slope since countries are not removing mpas? This would be automatic since regressing cumulative area on year (and have no info on areas removed). Also, if country reaches 10% goal, then the rate at which new area is added should go to zero. Then it is okay to have zero slope because the status will not decline in future - the required area has been allocated and status can only improve if all areas are managed. Then score of 100 is achieved.   


Cum_area_y = sum of all MPA areas established from year 1 to year y  

Cum_area_y = m*year_y + b; m = slope  

Trend = Future_year * m ; future_year = 5  

How to rescale trend?  If all values are between 0-1, do we need to rescale?  


#### 3.2.2 Alterative 2
There is limited information on MPA area from previous assessments. Need to read historic overview provided in [Baltic Sea Environment Proceedings NO. 124B Towards an ecologically coherent network of well-managed Marine Protected Areas](http://www.helcom.fi/lists/publications/bsep124b.pdf). Use this for the trend?  If area increasing, get positive trend?  

## 4. MPA data prep
Prep data layer

```{r TODO, echo=FALSE, message=FALSE}


## directory setup
dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
           'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
           'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

if (Sys.info()[['sysname']] != 'Linux' & !file.exists(dir_M)){
  warning(sprintf("The Mazu directory dir_M set in src/R/common.R does not exist. Do you need to mount Mazu: %s?", dir_M))
  # TODO: @jennifergriffiths reset dir_M to be where the SRC hold your shapefiles
}

dir_shp <- file.path(dir_M, 'git-annex/Baltic')



## libraries
library(dplyr)
library(rgdal)  # install.packages('rgdal')
library(raster) # install.packages('raster')
library(rgeos)  # install.packages('rgeos')

```

## Read in MPA and BHI regions shapefiles 
Also, get them in the same coordinate reference system for the Baltic. 

The MPA file is in the [LAEA coordinate reference system](http://spatialreference.org/ref/epsg/etrs89-etrs-laea/). 

```{r read in shapefiles, echo=FALSE, message=FALSE}

## inspect BHI regions ----
bhi <- rgdal::readOGR(dsn = path.expand(file.path(dir_shp, 'BHI_MCG_shapefile')),
                      layer = 'BHI_MCG_11052016')  
# bhi # coord. ref. : +proj=longlat


## explore/plot
plot(bhi) #takes ~15 seconds
# bhi@data


## inspect mpa file ----
mpa = rgdal::readOGR(dsn = path.expand(file.path(dir_shp, 'bhi_MPA')),
                     layer = 'HELCOM_MPAs') 
# mpa # coord. ref. : +proj=laea

## plot
plot(mpa) # quick
# head(mpa@data)


## transform bhi to mpa coordinate reference system (CRS) ----
## LAEA: http://spatialreference.org/ref/epsg/etrs89-etrs-laea/
## https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf
bhi = spTransform(bhi, mpa@proj4string)
# bhi # coord. ref. : +proj=laea

```

## Intersect BHI and HELCOM_MPA polygons

MPA regions were divided by with BHI region shape file, and thus we were able to calculate the total MPA area within each BHI region. MPA area per region is saved in the prep folder (`mpa_area_per_rgn.csv). 

The csv. file includes information: Area per MPA, Date established, MPA status, total MPA area per region.  



```{r intersect BHI and MPA, echo=FALSE, message=FALSE, cache=TRUE}

## plot on top of each other
plot(bhi, col = 'red', border = "green"); plot(mpa, col = 'blue', add = TRUE)

## system.time({mpa_bhi <- raster::intersect(mpa, bhi)}) # large file size and took hours to run. bhi ~ 45.5 Mb, mpa ~ 8.7 Mb.

plot(mpa_bhi, col ="red", border = "black")
# head(mpa_bhi@data)

## save mpa_bhi_data file to prep/LSP folder 

dir_prep = '~/github/bhi/baltic2015/prep/LSP'
write_csv(mpa_bhi@data, file.path(dir_prep, 'mpa_bhi_data.csv'))

## calculate total MPA area per region and save to prep_LSP folder 

mpa_bhi_data = read.csv(file.path(dir_prep, 'mpa_bhi_data.csv'))

### extract EEZ area (total area per BHI region) information from bhi shape file

EEZ = bhi@data %>%
      dplyr::select(BHI_ID, 
                    eez_area_km2 = Area_km2) 

mpa_area_per_rgn = mpa_bhi_data %>%
                   dplyr::select(name_shape = Name, 
                                 BSPA_ID,
                                 BHI_ID, 
                                 country = Country,
                                 status_shape = MPA_Status,
                                 mpa_area = AreaTot_Ha,
                                 date_est = Date_Est) %>%
                    mutate(mpa_area_km2 = mpa_area * 0.01) %>%
                    dplyr::select(-mpa_area) %>%
                    full_join(EEZ, 
                             by = "BHI_ID")

write_csv(mpa_area_per_rgn, file.path(dir_prep, 'mpa_area_per_rgn.csv')) 

## count unique names in shape file 
mpa_name_shape = select(mpa_area_per_rgn, name) 
unique_mpa_shape = base::unique(mpa_name_shape) ## 163 count


```


## Status Calculation

There are three types of management status (and their corresponding weight): Designated (0.3), Designated and Partially Managed (0.6), and Designated and Managed (1).  

MPS management status data comes from ( ...?...). While combining MPA management data with MPA area data from the shapefile, 7 MPAs from the shapefile did not have a match from the management dataset. For those MPAs, status from the shapefile, which were not as detailed and updated as the status data, were used: 

| MPA | BSPA_ID | BHI_ID| Country| Status |
| Torhamns Archipelago | 110 | 14 | Sweden | Designated |
| Walkyriengrund | 171 | 10 | Germany | Designated |
| OstseekÃ¼ste am Brodtener Ufer |178 | 10 | Germany | Designated |
| Fehmarnbelt | 180 | 7 | Germany | Designated |
| Kadetrinne | 181 | 12 | Germany | Designated | 
| Jasmund National Park | 2 | 13 | Germany | Managed |
| Vorpommersche Boddenlandshaft National Park (West-Pommeranian Lagoon National Park) | 3 | 13 | Germany | Managed |

The last two MPAs were assigned the weight of 0.6, the same as "Designated and Partially Managed". 

``` {r combine management status with mpa area and establishment info, echo = FALSE}

mgmt_status = read.csv(file.path(dir_prep, "mpa_data_database/MPA_status_download06June2016.csv"), sep = ";") %>%
              mutate(status = str_replace_all(Status, " ", "_")) %>%
              dplyr::select(name_csv = HELCOM_MPA_name,
                            BSPA_ID = ID,
                            status_csv = status) %>%
              dplyr::filter(!name_csv == "TEST SITE")

# count number of unique mpa names in new mpa mgmt status csv with a total of 175 observations

mpa_name = dplyr::select(mgmt_status, name_csv)
unique_mpa_csv_new = base::unique(mpa_name) ## total of 175 names that are unique. Including one "TEST SITE". 

# combine mpa_status with shape file data

mpa_mgmt = right_join(mgmt_status, mpa_area_per_rgn,  
                      by = "BSPA_ID") %>%
               mutate(mgmt_status = ifelse(is.na(status_csv), as.character(status_shape), status_csv),
                      # Mgmt_status = str_replace_all(mgmt_status, Managed, Designated_and_partially_managed),
                      date_est    = str_sub(date_est, start = -4)) # only select the year of establishment
             
write_csv(mpa_mgmt, file.path(dir_prep, 'mpa_mgmt_status_csv.csv'))

# count number of MPAs in shape file with no matches in csv file. 
# num_mismatch_new = dplyr::count(mpa_mgmt, !status_csv== "NA") 
# 13 rows (7 MPAs) have no match from the status csv file. For those, MPA status
# from the shape file were used (Designated or Managed). As a result, two MPAs
# have the status of "Managed": Jasmund National Park and Vorpommersche
# Boddenlandshaft National Park (West-Pommeranian Lagoon National Park) from
# Germany They are assigned "Designated and Partially Managed" status for
# calculations.


````


``` {r status calculation, ECHO = FALSE}

mgmt_weight = data.frame( mgmt_status = c("Designated", "Designated_and_partly_managed", "Designated_and_managed", "Managed"),
                          weight = c(0.3, 0.6, 1, 0.6) )

mpa_mgmt_with_wt = full_join( mgmt_weight, mpa_mgmt, 
                              by = 'mgmt_status') 

status_by_country =       mpa_mgmt_with_wt %>%
                 select(BHI_ID, country, eez_area_km2, mpa_area_km2, weight) %>%
                 filter(!duplicated(BHI_ID)) %>%
                 group_by(country) %>%
                 summarize(total_eez_km2 = sum(eez_area_km2), 
                           sum_wt_mpa_area = sum(mpa_area_km2 * weight)) %>%
                 ungroup %>%
                 mutate(ref = 0.1 * total_eez_km2, 
                        status = sum_wt_mpa_area / ref *100) %>%
                 select(country, 
                        status)


r.status = mpa_mgmt_with_wt %>%
           filter(!duplicated(BHI_ID)) %>%
           dplyr::select(rgn_id = BHI_ID, 
                  country) %>%
           full_join(status_by_country, 
                     by = 'country') %>% 
           dplyr::select(rgn_id, 
                         score = status) %>%
           mutate(dimension = 'status') 
                  
write_csv(r.status, file.path(dir_prep, 'lsp_status_by_rgn.csv'))

# # to save a cleaned version of mpa_mgmt_with_wt as a separate csv file? 
# mpa_mgmt_with_wt_cleaned = mpa_mgmt_with_wt %>%
#                            select(name = name_shape, 
#                                   BHI_ID, 
#                                   BSPA_ID, 
#                                   country, 
#                                   mpa_area_km2, 
#                                   eez_area_km2, 
#                                   mgmt_status, 
#                                   weight, 
#                                   date_est)

```

``` {r trend calculation, ECHO = FALSE}




``` 
