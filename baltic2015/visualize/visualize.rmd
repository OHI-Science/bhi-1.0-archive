---
title: "visualize"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---

# Visualize data dimensions and goals outcomes
```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## source common libraries, directories, functions, etc
source('~/github/bhi/baltic2015/prep/common.r')

## rprojroot
root <- rprojroot::is_rstudio_project


## make_path() function to 
make_path <- function(...) rprojroot::find_root_file(..., criterion = is_rstudio_project)



dir_layers = make_path('baltic2015/layers') # replaces  file.path(dir_baltic, 'layers')


# root$find_file("README.md")
# 
# root$find_file("ao_need_gl2014.csv")
# 
# root <- find_root_file("install_ohicore.r", 
# 
# withr::with_dir(
#   root_file("DESCRIPTION"))

dir_vis    = file.path(dir_baltic,'visualize')


## add a README.md to the prep directory with the rawgit.com url for viewing on GitHub
create_readme(dir_vis, 'visualize.rmd')
```

## 1. Visualize Functions

## 1.1 Map data location with lat, lon
```{r Spatial raw data with lat lon}


plot_datalocation_latlon = function(mapdata){
        ##mapdata 
        ## dataframe with columns
            ##lat
            ##lon
            ##data_descrip
            ##bhi_goal
        

  
      ## get the Baltic Sea map template
      require('ggmap')
      map = get_map(location = c(8.5, 53, 32, 67.5))
      
    
      
      ##set up plot
      plot_map = ggmap(map) +
      geom_point(aes(x=lon, y=lat), data=mapdata,size = 1.5)
  
      
      
      ##plot the map
     return( plot_map +
      ggtitle(paste(mapdata[1,3],"for goal", mapdata[1,4])) +
      theme(title = element_text(size = 11)))
      
} ## end function



```

## 1.2 Time series by station
```{r Times seres by station}

plot_datatime = function(timedata, facet_type, variable = TRUE){
        ##timedata - dataframe with columns
            ##year
            ##value
            ##unit 
            ##station, basin, rgn_id - at least one required
            ##variable - this is for color/shape coding
            ##bhi_goal
            ##data_descrip
  
        ##facet_type
          ##single character vector describing the facet_wrap option
              ## "station", "basin", "rgn_id"
  
    if(variable == FALSE){
    
    facet = data.frame(facet=timedata[,facet_type])
    
    timedata = timedata %>%
               select(year,value,unit,bhi_goal,data_descrip)%>%
               bind_cols(.,facet)
    
    p = ggplot(timedata)+
    geom_point(aes(year,value))+
    facet_wrap(~facet)
 
    return(p+
     ylab(paste(timedata[1,"unit"]))+
     theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
    ggtitle(paste(timedata[1,"data_descrip"], "for goal",
                  timedata[1,"bhi_goal"], "by", facet_type )))
    }
  
  if(variable == TRUE){
    
    facet = data.frame(facet=timedata[,facet_type])
    
    timedata = timedata %>%
               select(year,value,unit,bhi_goal,data_descrip,variable)%>%
               bind_cols(.,facet)
    
    p = ggplot(timedata)+
    geom_point(aes(year,value, colour=variable))+
    facet_wrap(~facet)
 
    return(p+
     ylab(paste(timedata[1,"unit"]))+
     theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
    ggtitle(paste(timedata[1,"data_descrip"], "for goal",
                  timedata[1,"bhi_goal"], "by", facet_type )))
    }
  
       
}


```

## Value by station - Not timeseries
```{r value by station function}

plot_datavalue = function(valuedata, variable = TRUE){
        ##valuedata - dataframe with columns
            ##value
            ##unit 
            ##location - primary location for x axis
            ##variable - this for faceting
            ##bhi_goal
            ##data_descrip
  
        ##facet_type
          ##single character vector describing the facet_wrap option
              ## "station", "basin", "rgn_id"
  
    if(variable == FALSE){
    
 
    
    valuedata = valuedata %>%
               select(location,value,unit,bhi_goal,data_descrip)
               
    
    p = ggplot(valuedata)+
    geom_point(aes(location,value))
  
 
    return(p+
     ylab(paste(valuedata[1,"unit"]))+
     theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
    ggtitle(paste(valuedata[1,"data_descrip"], "for goal",
                  valuedata[1,"bhi_goal"])))
    }
  
  
  if(variable == TRUE){
    
    
    valuedata = valuedata %>%
               select(location,value,unit,bhi_goal,data_descrip,variable)
    
    p = ggplot(valuedata)+
    geom_point(aes(location,value))+
      facet_wrap(~variable)
 
    return(p+
     ylab(paste(valuedata[1,"unit"]))+
     theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
    ggtitle(paste(valuedata[1,"data_descrip"], "for goal",
                  valuedata[1,"bhi_goal"])))
    }
  
       
}



```



## 1.3 Source PlotMap function
```{r source plotmap function}
source('PlotMap.r') 
source('PrepSpatial.r') 



```


## Test the plots
```{r test the plots}
testdata = data.frame(lat = c(55.3163,60.5326,57.3167),
                        lon = c(13.611,18.1624,17.5),
                        data_descrip =rep("test plot",3),
                        bhi_goal=rep("MAR",3))



testdata1 = data.frame(year = rep(seq(2000,2005,1),4),
                       value = rep(seq(22,27,1),4),
                       unit = rep("mg",24),
                       station =c(rep("A",6),rep("B",6),rep("C",6),rep("D",6)),
                       data_descrip =rep("test plot",24),
                       bhi_goal=rep("NNN",24))


testdata2 = data.frame(year = rep(seq(2000,2005,1),4),
                       value = rep(seq(22,27,1),4),
                       unit = rep("mg",24),
                       variable=rep(c("help","out"),12),
                       station =c(rep("A",6),rep("B",6),rep("C",6),rep("D",6)),
                       data_descrip =rep("test plot",24),
                       bhi_goal=rep("NNN",24))


testscores = read.csv(file.path(dir_baltic,'scores.csv'),stringsAsFactors =FALSE)%>%
              filter(goal=='AO')

##test plot
plot_datalocation_latlon(testdata)


plot_datatime (testdata1, "station", variable=FALSE)
plot_datatime (testdata2, "station", variable=TRUE)

# PlotMap(filter(testscores, dimension=="future"),        # dataframe with at least 2 columns: rgn_id and scores/values.
#                     rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
#                     map_title       = element_blank(),
#                     fld_rgn         = 'region_id',
#                     fld_score       = 'score',
#                     scale_label     = 'score',
#                     scale_limits    = c(0, 100),
#                     print_fig       = TRUE, ### print to display
#                     fig_path        = NULL)
# 
# 
# PlotMap(filter(testscores, dimension=="pressures"),        # dataframe with at least 2 columns: rgn_id and scores/values.
#                     rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
#                     map_title       = element_blank(),
#                     fld_rgn         = 'region_id',
#                     fld_score       = 'score',
#                     scale_label     = 'score',
#                     scale_limits    = c(0, 100),
#                     print_fig       = TRUE, ### print to display
#                     fig_path        = NULL)

```



## Set local directory for pdf output
```{r Set local directory for pdf output}

pdf_dir = c("C:/Users/jgrif/Documents/StockholmUnivPostDoc/BalticHealthIndex/Output")

```



## AO Goal

```{r AO plots}

## set values and location
goal = "AO"

##data
space_data = read.csv(file.path(dir_vis,'ao_space_data.csv'), stringsAsFactors = FALSE)
#time_data
value_data = read.csv(file.path(dir_vis,'ao_value_data.csv'), stringsAsFactors = FALSE)
  
##Scores
scores = read.csv(file.path(dir_baltic,'scores.csv'),stringsAsFactors =FALSE)%>%
              filter(goal==goal)


##-------------------------------------------##
## Save PDF of Plots

pdf(paste(pdf_dir,"/output_",goal,".pdf", sep=""))



      ##plot raw spatial
      plot_datalocation_latlon(space_data)
      
      ## plot raw values single time period by staton
      plot_datavalue(value_data, variable=TRUE)
      
      ##plot raw times series by station
      #plot_datatime (time_data, "station", variable=TRUE)
      
      ##plot raw time series by basin
      #plot_datatime (time_data, "basin", variable=TRUE)
      
      
      ##plot status map
      PlotMap(filter(scores, dimension=="status"),        # dataframe with at least 2 columns: rgn_id and scores/values.
              rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
              map_title       = element_blank(),
              fld_rgn         = 'region_id',
              fld_score       = 'score',
              scale_label     = 'status score',
              scale_limits    = c(0, 100),
              print_fig       = TRUE, ### print to display
              fig_path        = NULL)
      
      
      ##plot pressures map
      PlotMap(filter(scores, dimension=="pressures"),        # dataframe with at least 2 columns: rgn_id and scores/values.
              rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
              map_title       = element_blank(),
              fld_rgn         = 'region_id',
              fld_score       = 'score',
              scale_label     = 'pressures score',
              scale_limits    = c(0, 100),
              print_fig       = TRUE, ### print to display
              fig_path        = NULL)
      
      
      ##plot resilience map
      PlotMap(filter(scores, dimension=="resilience"),        # dataframe with at least 2 columns: rgn_id and scores/values.
              rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
              map_title       = element_blank(),
              fld_rgn         = 'region_id',
              fld_score       = 'score',
              scale_label     = 'resilience score',
              scale_limits    = c(0, 100),
              print_fig       = TRUE, ### print to display
              fig_path        = NULL)
      
      
      ##plot future map
      PlotMap(filter(scores, dimension=="future"),        # dataframe with at least 2 columns: rgn_id and scores/values.
              rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
              map_title       = element_blank(),
              fld_rgn         = 'region_id',
              fld_score       = 'score',
              scale_label     = 'future score',
              scale_limits    = c(0, 100),
              print_fig       = TRUE, ### print to display
              fig_path        = NULL)
      
      
      
      ## plot scores map
      PlotMap(filter(scores, dimension=="score"),        # dataframe with at least 2 columns: rgn_id and scores/values.
              rgn_poly        = PrepSpatial('spatial/regions_gcs.geojson'), # default for OHI+
              map_title       = element_blank(),
              fld_rgn         = 'region_id',
              fld_score       = 'score',
              scale_label     = 'score',
              scale_limits    = c(0, 100),
              print_fig       = TRUE, ### print to display
              fig_path        = NULL)


dev.off() ## Finish PDF





```

